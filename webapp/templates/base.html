<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Blue Deer{% endblock %} | Property Management</title>
    <link rel="icon" type="image/png" href="/static/images/favicon.png">
    <link rel="apple-touch-icon" href="/static/images/favicon.png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Custom styles -->
    <style>
        [x-cloak] { display: none !important; }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: inline-block; }
        .htmx-request.htmx-indicator { display: inline-block; }

        /* Background image with soft overlay */
        body {
            position: relative;
        }
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background-image: url('/static/images/bluedeebg.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            z-index: -2;
        }
        body::after {
            content: "";
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.70);
            z-index: -1;
        }

        /* Gradient background */
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #0ea5e9 100%);
        }

        /* Card hover effect */
        .card-hover {
            transition: all 0.2s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        /* Status pulse animation */
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-dot {
            animation: pulse-dot 2s ease-in-out infinite;
        }

        /* Nav dropdown animation */
        .nav-dropdown {
            transform-origin: top;
            transition: opacity 0.15s ease, transform 0.15s ease;
        }
        .nav-dropdown.hidden {
            opacity: 0;
            transform: scale(0.95) translateY(-4px);
            pointer-events: none;
        }

        /* Search modal */
        .search-backdrop {
            transition: opacity 0.15s ease;
        }
        .search-modal {
            transition: opacity 0.15s ease, transform 0.15s ease;
        }
        .search-result-active {
            background-color: #f3f4f6;
        }
    </style>

    {% block head %}{% endblock %}
</head>
<body class="h-full bg-gray-50">
    <div class="min-h-full">
        <!-- Navigation -->
        {% if user %}
        {# Active state logic #}
        {% set portfolio_active = '/properties' in request.url.path or '/tenants' in request.url.path or '/leases' in request.url.path or '/phas' in request.url.path %}
        {% set operations_active = '/maintenance' in request.url.path or '/inspections' in request.url.path or '/bills' in request.url.path or ('/notifications' in request.url.path and '/notifications/chat' not in request.url.path) %}
        {% set messages_active = '/notifications/chat' in request.url.path %}

        <nav class="gradient-bg shadow-lg relative z-40">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 items-center justify-between">
                    <!-- Left: Logo + Primary Nav -->
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <a href="/" class="text-white font-bold text-xl flex items-center gap-2">
                                <img src="/static/images/logo.png" alt="Blue Deer" class="h-10 w-10 object-contain">
                                <span class="hidden sm:inline">Blue Deer</span>
                            </a>
                        </div>
                        <div class="hidden lg:block">
                            <div class="ml-6 flex items-center space-x-1">
                                <!-- Dashboard (direct link) -->
                                <a href="/" class="{% if request.url.path == '/' %}bg-white/20{% endif %} text-white rounded-lg px-3 py-2 text-sm font-medium hover:bg-white/10 flex items-center gap-2 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25a2.25 2.25 0 0 1-2.25-2.25v-2.25Z" />
                                    </svg>
                                    Dashboard
                                </a>

                                <!-- Portfolio dropdown -->
                                <div class="relative" data-dropdown="portfolio">
                                    <button onclick="toggleDropdown('portfolio')" class="{% if portfolio_active %}bg-white/20{% endif %} text-white rounded-lg px-3 py-2 text-sm font-medium hover:bg-white/10 flex items-center gap-1.5 transition-colors cursor-pointer">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5M3.75 3v18m16.5-18v18M5.25 3h13.5M5.25 21h13.5M9 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6H15m-1.5 3H15m-1.5 3H15" />
                                        </svg>
                                        Portfolio
                                        <svg class="w-3.5 h-3.5 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div id="dropdown-portfolio" class="nav-dropdown hidden absolute left-0 mt-2 w-72 bg-white rounded-xl shadow-lg border border-gray-200 py-2 z-50">
                                        <a href="/properties" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors {{ 'bg-blue-50' if '/properties' in request.url.path else '' }}">
                                            <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">Properties</div>
                                                <div class="text-xs text-gray-500">Property portfolio</div>
                                            </div>
                                        </a>
                                        <a href="/tenants" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors {{ 'bg-blue-50' if '/tenants' in request.url.path else '' }}">
                                            <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-violet-100 flex items-center justify-center">
                                                <svg class="w-4 h-4 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">Tenants</div>
                                                <div class="text-xs text-gray-500">Tenant management</div>
                                            </div>
                                        </a>
                                        <a href="/leases" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors {{ 'bg-blue-50' if '/leases' in request.url.path else '' }}">
                                            <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-amber-100 flex items-center justify-center">
                                                <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">Leases</div>
                                                <div class="text-xs text-gray-500">Lease documents</div>
                                            </div>
                                        </a>
                                        <a href="/phas" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors {{ 'bg-blue-50' if '/phas' in request.url.path else '' }}">
                                            <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                                                <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75Z" />
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">PHAs</div>
                                                <div class="text-xs text-gray-500">Housing authorities</div>
                                            </div>
                                        </a>
                                    </div>
                                </div>

                                <!-- Operations dropdown -->
                                <div class="relative" data-dropdown="operations">
                                    <button onclick="toggleDropdown('operations')" class="{% if operations_active %}bg-white/20{% endif %} text-white rounded-lg px-3 py-2 text-sm font-medium hover:bg-white/10 flex items-center gap-1.5 transition-colors cursor-pointer">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.049.58.025 1.193-.14 1.743" />
                                        </svg>
                                        Operations
                                        <svg class="w-3.5 h-3.5 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    <div id="dropdown-operations" class="nav-dropdown hidden absolute left-0 mt-2 w-72 bg-white rounded-xl shadow-lg border border-gray-200 py-2 z-50">
                                        <a href="/maintenance" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors {{ 'bg-blue-50' if '/maintenance' in request.url.path and '/maintenance/vendors' not in request.url.path else '' }}">
                                            <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center">
                                                <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.049.58.025 1.193-.14 1.743" />
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">Maintenance</div>
                                                <div class="text-xs text-gray-500">Work orders</div>
                                            </div>
                                        </a>
                                        <a href="/inspections" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors {{ 'bg-blue-50' if '/inspections' in request.url.path else '' }}">
                                            <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-sky-100 flex items-center justify-center">
                                                <svg class="w-4 h-4 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12Zm0 3h.008v.008H6.75V15Zm0 3h.008v.008H6.75V18Z" />
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">Inspections</div>
                                                <div class="text-xs text-gray-500">CO, rental, Section 8</div>
                                            </div>
                                        </a>
                                        <a href="/bills" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors {{ 'bg-blue-50' if '/bills' in request.url.path else '' }}">
                                            <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-cyan-100 flex items-center justify-center">
                                                <svg class="w-4 h-4 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">Water Bills</div>
                                                <div class="text-xs text-gray-500">Bill tracking</div>
                                            </div>
                                        </a>
                                        <div class="border-t border-gray-100 my-1.5"></div>
                                        <a href="/maintenance/vendors" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors {{ 'bg-blue-50' if '/maintenance/vendors' in request.url.path else '' }}">
                                            <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-rose-100 flex items-center justify-center">
                                                <svg class="w-4 h-4 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">Vendors</div>
                                                <div class="text-xs text-gray-500">Vendor directory</div>
                                            </div>
                                        </a>
                                        <a href="/notifications" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors {{ 'bg-blue-50' if '/notifications' in request.url.path and '/notifications/chat' not in request.url.path else '' }}">
                                            <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center">
                                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
                                                </svg>
                                            </div>
                                            <div>
                                                <div class="text-sm font-medium text-gray-900">Notifications</div>
                                                <div class="text-xs text-gray-500">SMS/email history</div>
                                            </div>
                                        </a>
                                    </div>
                                </div>

                                <!-- Messages (direct link with badge) -->
                                <a href="/notifications/chat" class="relative {% if messages_active %}bg-white/20{% endif %} text-white rounded-lg px-3 py-2 text-sm font-medium hover:bg-white/10 flex items-center gap-2 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" />
                                    </svg>
                                    Messages
                                    <span id="unread-badge" class="hidden absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 rounded-full bg-red-500 text-white text-[10px] font-bold flex items-center justify-center leading-none"></span>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Quick Create + Search + User -->
                    <div class="hidden lg:flex items-center gap-2">
                        <!-- Quick Create (+) -->
                        <div class="relative" data-dropdown="quickcreate">
                            <button onclick="toggleDropdown('quickcreate')" class="w-8 h-8 rounded-full bg-white/20 hover:bg-white/30 text-white flex items-center justify-center transition-colors cursor-pointer" title="Quick create">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                </svg>
                            </button>
                            <div id="dropdown-quickcreate" class="nav-dropdown hidden absolute right-0 mt-2 w-52 bg-white rounded-xl shadow-lg border border-gray-200 py-2 z-50">
                                <div class="px-3 py-1.5 text-[10px] font-semibold text-gray-400 uppercase tracking-wider">Quick Create</div>
                                <a href="/properties/new" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                                    </svg>
                                    <span class="text-sm text-gray-700">New Property</span>
                                </a>
                                <a href="/tenants/new" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z" />
                                    </svg>
                                    <span class="text-sm text-gray-700">New Tenant</span>
                                </a>
                                <a href="/maintenance/new" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.049.58.025 1.193-.14 1.743" />
                                    </svg>
                                    <span class="text-sm text-gray-700">New Work Order</span>
                                </a>
                            </div>
                        </div>

                        <!-- Search button -->
                        <button onclick="openSearchModal()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-colors cursor-pointer" title="Search (Cmd+K)">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                            </svg>
                        </button>

                        <!-- Divider -->
                        <div class="h-6 w-px bg-white/20 mx-1"></div>

                        <!-- User dropdown -->
                        <div class="relative" data-dropdown="user">
                            <button onclick="toggleDropdown('user')" class="text-white/90 text-sm flex items-center gap-2 px-2.5 py-1.5 bg-white/10 rounded-lg hover:bg-white/20 transition-colors cursor-pointer">
                                <div class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                                    </svg>
                                </div>
                                <span class="font-medium max-w-[120px] truncate">{{ user.name or user.email }}</span>
                                <svg class="w-3.5 h-3.5 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div id="dropdown-user" class="nav-dropdown hidden absolute right-0 mt-2 w-52 bg-white rounded-xl shadow-lg border border-gray-200 py-2 z-50">
                                <div class="px-4 py-2 border-b border-gray-100">
                                    <div class="text-sm font-medium text-gray-900 truncate">{{ user.name or 'User' }}</div>
                                    <div class="text-xs text-gray-500 truncate">{{ user.email }}</div>
                                </div>
                                <a href="/profile" class="flex items-center gap-2.5 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors mt-1">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                                    </svg>
                                    Settings
                                </a>
                                {% if user.is_admin %}
                                <a href="/admin/users" class="flex items-center gap-2.5 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
                                    </svg>
                                    Manage Users
                                </a>
                                {% endif %}
                                <a href="/listings" target="_blank" class="flex items-center gap-2.5 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" />
                                    </svg>
                                    Public Site
                                </a>
                                <div class="border-t border-gray-100 my-1"></div>
                                <a href="/logout" class="flex items-center gap-2.5 px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
                                    </svg>
                                    Logout
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile: right side buttons -->
                    <div class="flex items-center gap-2 lg:hidden">
                        <!-- Mobile search -->
                        <button onclick="openSearchModal()" class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 text-white flex items-center justify-center transition-colors cursor-pointer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                            </svg>
                        </button>
                        <!-- Mobile menu button -->
                        <button type="button" onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="inline-flex items-center justify-center rounded-lg bg-white/20 p-2 text-white hover:bg-white/30 transition-colors">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mobile menu -->
            <div class="lg:hidden hidden" id="mobile-menu">
                <div class="px-2 pb-3 pt-2 sm:px-3">
                    <!-- Dashboard -->
                    <a href="/" class="text-white flex items-center gap-3 rounded-lg px-3 py-2.5 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25a2.25 2.25 0 0 1-2.25-2.25v-2.25Z" /></svg>
                        Dashboard
                    </a>

                    <!-- Portfolio section -->
                    <div class="mt-3 mb-1 px-3">
                        <span class="text-[10px] font-semibold text-white/50 uppercase tracking-wider">Portfolio</span>
                    </div>
                    <a href="/properties" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>
                        Properties
                    </a>
                    <a href="/tenants" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" /></svg>
                        Tenants
                    </a>
                    <a href="/leases" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>
                        Leases
                    </a>
                    <a href="/phas" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75Z" /></svg>
                        PHAs
                    </a>

                    <!-- Operations section -->
                    <div class="mt-3 mb-1 px-3">
                        <span class="text-[10px] font-semibold text-white/50 uppercase tracking-wider">Operations</span>
                    </div>
                    <a href="/maintenance" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.049.58.025 1.193-.14 1.743" /></svg>
                        Maintenance
                    </a>
                    <a href="/inspections" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75 2.25 2.25 0 0 0-.1-.664m-5.8 0A2.251 2.251 0 0 1 13.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25ZM6.75 12h.008v.008H6.75V12Zm0 3h.008v.008H6.75V15Zm0 3h.008v.008H6.75V18Z" /></svg>
                        Inspections
                    </a>
                    <a href="/bills" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                        Water Bills
                    </a>
                    <a href="/maintenance/vendors" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                        Vendors
                    </a>
                    <a href="/notifications" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" /></svg>
                        Notifications
                    </a>

                    <!-- Messages -->
                    <div class="mt-3 mb-1 px-3">
                        <span class="text-[10px] font-semibold text-white/50 uppercase tracking-wider">Communication</span>
                    </div>
                    <a href="/notifications/chat" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" /></svg>
                        Messages
                        <span id="mobile-unread-badge" class="hidden ml-auto min-w-[20px] h-5 px-1.5 rounded-full bg-red-500 text-white text-xs font-bold flex items-center justify-center"></span>
                    </a>

                    <!-- Quick Create -->
                    <div class="mt-3 mb-1 px-3">
                        <span class="text-[10px] font-semibold text-white/50 uppercase tracking-wider">Quick Create</span>
                    </div>
                    <a href="/properties/new" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        New Property
                    </a>
                    <a href="/tenants/new" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        New Tenant
                    </a>
                    <a href="/maintenance/new" class="text-white flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium hover:bg-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        New Work Order
                    </a>
                </div>

                <!-- Mobile user section -->
                <div class="border-t border-white/20 pb-3 pt-4">
                    <div class="flex items-center px-5 gap-3 text-white">
                        <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                        </div>
                        <div>
                            <div class="font-medium">{{ user.name or 'User' }}</div>
                            <div class="text-xs text-white/60">{{ user.email }}</div>
                        </div>
                    </div>
                    <div class="mt-3 space-y-1 px-2">
                        <a href="/profile" class="flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium text-white hover:bg-white/10">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                            Settings
                        </a>
                        {% if user.is_admin %}
                        <a href="/admin/users" class="flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium text-white hover:bg-white/10">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" /></svg>
                            Manage Users
                        </a>
                        {% endif %}
                        <a href="/listings" target="_blank" class="flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium text-white hover:bg-white/10">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" /></svg>
                            Public Site
                        </a>
                        <a href="/logout" class="flex items-center gap-3 rounded-lg px-3 py-2 text-base font-medium text-red-300 hover:bg-white/10">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" /></svg>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </nav>
        {% endif %}

        <!-- Search Modal (Cmd+K) -->
        <div id="search-modal" class="hidden fixed inset-0 z-[100]">
            <div class="search-backdrop absolute inset-0 bg-black/50" onclick="closeSearchModal()"></div>
            <div class="search-modal relative mx-auto mt-[15vh] max-w-lg w-full px-4">
                <div class="bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
                    <!-- Search input -->
                    <div class="flex items-center gap-3 px-4 py-3 border-b border-gray-100">
                        <svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                        </svg>
                        <input id="search-input" type="text" placeholder="Search properties, tenants, work orders..." class="flex-1 text-base text-gray-900 placeholder-gray-400 outline-none bg-transparent" autocomplete="off" oninput="handleSearchInput(this.value)">
                        <kbd class="hidden sm:inline-flex items-center gap-1 rounded border border-gray-200 bg-gray-50 px-1.5 py-0.5 text-[10px] font-medium text-gray-400">ESC</kbd>
                    </div>
                    <!-- Results -->
                    <div id="search-results" class="max-h-[60vh] overflow-y-auto">
                        <div id="search-empty" class="px-4 py-8 text-center text-sm text-gray-400">
                            Start typing to search...
                        </div>
                        <div id="search-loading" class="hidden px-4 py-8 text-center text-sm text-gray-400">
                            <svg class="animate-spin h-5 w-5 mx-auto mb-2 text-blue-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                            Searching...
                        </div>
                        <div id="search-results-list" class="hidden"></div>
                        <div id="search-no-results" class="hidden px-4 py-8 text-center text-sm text-gray-400">
                            No results found
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page header -->
        {% block header %}{% endblock %}

        <!-- Main content -->
        <main>
            <div class="mx-auto max-w-7xl py-6 px-4 sm:px-6 lg:px-8">
                {% block content %}{% endblock %}
            </div>
        </main>

        <!-- Footer -->
        {% if user %}
        <footer class="mt-auto py-6 text-center text-sm text-gray-500">
            <p class="flex items-center justify-center gap-2">
                <img src="/static/images/logo.png" alt="Blue Deer" class="h-6 w-6 object-contain">
                Blue Deer Property Management
            </p>
        </footer>
        {% endif %}
    </div>

    <!-- Toast notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        //  Dropdown Management 
        function toggleDropdown(name) {
            const allDropdowns = document.querySelectorAll('[id^="dropdown-"]');
            allDropdowns.forEach(dd => {
                if (dd.id !== 'dropdown-' + name) {
                    dd.classList.add('hidden');
                }
            });
            const target = document.getElementById('dropdown-' + name);
            if (target) target.classList.toggle('hidden');
        }

        // Close all dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const clickedDropdownParent = event.target.closest('[data-dropdown]');
            if (!clickedDropdownParent) {
                document.querySelectorAll('[id^="dropdown-"]').forEach(dd => {
                    dd.classList.add('hidden');
                });
            }
        });

        //  Search Modal 
        let searchDebounce = null;
        let searchResultIndex = -1;

        function openSearchModal() {
            const modal = document.getElementById('search-modal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            setTimeout(() => document.getElementById('search-input').focus(), 50);
            // Close mobile menu if open
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu) mobileMenu.classList.add('hidden');
        }

        function closeSearchModal() {
            const modal = document.getElementById('search-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            document.getElementById('search-input').value = '';
            document.getElementById('search-empty').classList.remove('hidden');
            document.getElementById('search-loading').classList.add('hidden');
            document.getElementById('search-results-list').classList.add('hidden');
            document.getElementById('search-no-results').classList.add('hidden');
            searchResultIndex = -1;
        }

        // Cmd+K / Ctrl+K to open search
        document.addEventListener('keydown', function(e) {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                const modal = document.getElementById('search-modal');
                if (modal.classList.contains('hidden')) {
                    openSearchModal();
                } else {
                    closeSearchModal();
                }
            }
            if (e.key === 'Escape') {
                closeSearchModal();
            }
        });

        // Search input handler with debounce
        function handleSearchInput(value) {
            clearTimeout(searchDebounce);
            searchResultIndex = -1;

            if (!value || value.length < 2) {
                document.getElementById('search-empty').classList.remove('hidden');
                document.getElementById('search-loading').classList.add('hidden');
                document.getElementById('search-results-list').classList.add('hidden');
                document.getElementById('search-no-results').classList.add('hidden');
                return;
            }

            document.getElementById('search-empty').classList.add('hidden');
            document.getElementById('search-loading').classList.remove('hidden');
            document.getElementById('search-results-list').classList.add('hidden');
            document.getElementById('search-no-results').classList.add('hidden');

            searchDebounce = setTimeout(() => fetchSearchResults(value), 300);
        }

        async function fetchSearchResults(query) {
            try {
                const resp = await fetch('/api/search?q=' + encodeURIComponent(query));
                const data = await resp.json();

                document.getElementById('search-loading').classList.add('hidden');

                const list = document.getElementById('search-results-list');
                list.innerHTML = '';

                let hasResults = false;

                // Properties
                if (data.properties && data.properties.length > 0) {
                    hasResults = true;
                    list.innerHTML += '<div class="px-3 py-1.5 text-[10px] font-semibold text-gray-400 uppercase tracking-wider">Properties</div>';
                    data.properties.forEach(p => {
                        list.innerHTML += `<a href="/properties/${p.id}" class="search-result flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors" data-search-result>
                            <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center flex-shrink-0">
                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>
                            </div>
                            <div class="min-w-0"><div class="text-sm font-medium text-gray-900 truncate">${p.address}</div><div class="text-xs text-gray-500">${p.city}</div></div>
                        </a>`;
                    });
                }

                // Tenants
                if (data.tenants && data.tenants.length > 0) {
                    hasResults = true;
                    list.innerHTML += '<div class="px-3 py-1.5 text-[10px] font-semibold text-gray-400 uppercase tracking-wider mt-1">Tenants</div>';
                    data.tenants.forEach(t => {
                        list.innerHTML += `<a href="/tenants/${t.id}" class="search-result flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors" data-search-result>
                            <div class="w-8 h-8 rounded-lg bg-violet-100 flex items-center justify-center flex-shrink-0">
                                <svg class="w-4 h-4 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                            </div>
                            <div class="min-w-0"><div class="text-sm font-medium text-gray-900 truncate">${t.name}</div><div class="text-xs text-gray-500 truncate">${t.property}</div></div>
                        </a>`;
                    });
                }

                // Work Orders
                if (data.work_orders && data.work_orders.length > 0) {
                    hasResults = true;
                    list.innerHTML += '<div class="px-3 py-1.5 text-[10px] font-semibold text-gray-400 uppercase tracking-wider mt-1">Work Orders</div>';
                    data.work_orders.forEach(w => {
                        list.innerHTML += `<a href="/maintenance/${w.id}" class="search-result flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors" data-search-result>
                            <div class="w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center flex-shrink-0">
                                <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.049.58.025 1.193-.14 1.743" /></svg>
                            </div>
                            <div class="min-w-0"><div class="text-sm font-medium text-gray-900 truncate">${w.title}</div><div class="text-xs text-gray-500 truncate">${w.property} &middot; ${w.status}</div></div>
                        </a>`;
                    });
                }

                if (hasResults) {
                    list.classList.remove('hidden');
                    list.innerHTML += '<div class="pb-2"></div>';
                } else {
                    document.getElementById('search-no-results').classList.remove('hidden');
                }

            } catch (err) {
                document.getElementById('search-loading').classList.add('hidden');
                document.getElementById('search-no-results').classList.remove('hidden');
            }
        }

        // Keyboard navigation in search results
        document.getElementById('search-input').addEventListener('keydown', function(e) {
            const results = document.querySelectorAll('[data-search-result]');
            if (!results.length) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                searchResultIndex = Math.min(searchResultIndex + 1, results.length - 1);
                updateSearchHighlight(results);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                searchResultIndex = Math.max(searchResultIndex - 1, 0);
                updateSearchHighlight(results);
            } else if (e.key === 'Enter' && searchResultIndex >= 0) {
                e.preventDefault();
                results[searchResultIndex].click();
            }
        });

        function updateSearchHighlight(results) {
            results.forEach((r, i) => {
                r.classList.toggle('search-result-active', i === searchResultIndex);
                if (i === searchResultIndex) r.scrollIntoView({ block: 'nearest' });
            });
        }

        //  Unread Messages Badge 
        async function fetchUnreadCount() {
            try {
                const resp = await fetch('/api/unread-count');
                const data = await resp.json();
                const badge = document.getElementById('unread-badge');
                const mobileBadge = document.getElementById('mobile-unread-badge');
                if (data.unread > 0) {
                    const text = data.unread > 99 ? '99+' : String(data.unread);
                    if (badge) { badge.textContent = text; badge.classList.remove('hidden'); }
                    if (mobileBadge) { mobileBadge.textContent = text; mobileBadge.classList.remove('hidden'); }
                } else {
                    if (badge) badge.classList.add('hidden');
                    if (mobileBadge) mobileBadge.classList.add('hidden');
                }
            } catch (e) { /* silent */ }
        }
        // Fetch on load, then poll every 30 seconds
        fetchUnreadCount();
        setInterval(fetchUnreadCount, 30000);

        //  Toast notifications 
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-green-500';
            toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 flex items-center gap-2 text-sm`;
            const icon = type === 'error' ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>'
                       : type === 'warning' ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>'
                       : '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>';
            toast.innerHTML = `${icon}<span>${message}</span>`;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // HTMX event handlers
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            // Handle flash messages or toast triggers
        });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>

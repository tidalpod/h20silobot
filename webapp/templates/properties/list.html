{% extends "base.html" %}

{% block title %}Properties{% endblock %}

{% block header %}
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8 flex justify-between items-center">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900">Properties</h1>
        <div class="flex gap-2">
            <button hx-post="/api/refresh-bills" hx-swap="none"
                    onclick="this.innerHTML='<span class=\'animate-pulse\'>Refreshing...</span>'; this.disabled=true; setTimeout(() => { this.innerHTML='ğŸ”„ Refresh Bills'; this.disabled=false; location.reload(); }, 15000);"
                    class="inline-flex items-center rounded-md bg-gray-100 px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-200">
                ğŸ”„ Refresh Bills
            </button>
            <a href="/properties/new" class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">
                <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Add Property
            </a>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<!-- Total Rent Tracker -->
{% set total_rent = namespace(amount=0, section8=0, regular=0, count=0) %}
{% for item in properties %}
    {% set active_tenants = item.property.tenants | selectattr('is_active', 'true') | list %}
    {% if active_tenants %}
        {% set primary_tenant = active_tenants | selectattr('is_primary', 'true') | first %}
        {% set rent_tenant = primary_tenant if primary_tenant else active_tenants[0] %}
        {% if rent_tenant.is_section8 and (rent_tenant.voucher_amount or rent_tenant.tenant_portion) %}
            {% set voucher = rent_tenant.voucher_amount|float if rent_tenant.voucher_amount else 0 %}
            {% set portion = rent_tenant.tenant_portion|float if rent_tenant.tenant_portion else 0 %}
            {% set total_rent.amount = total_rent.amount + voucher + portion %}
            {% set total_rent.section8 = total_rent.section8 + voucher + portion %}
            {% set total_rent.count = total_rent.count + 1 %}
        {% elif rent_tenant.current_rent %}
            {% set total_rent.amount = total_rent.amount + rent_tenant.current_rent|float %}
            {% set total_rent.regular = total_rent.regular + rent_tenant.current_rent|float %}
            {% set total_rent.count = total_rent.count + 1 %}
        {% endif %}
    {% endif %}
{% endfor %}

<div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg shadow mb-6 px-6 py-4">
    <div class="flex items-center justify-between">
        <div>
            <p class="text-blue-100 text-sm font-medium">Total Monthly Rent</p>
            <p class="text-white text-3xl font-bold">${{ "{:,.0f}".format(total_rent.amount) }}<span class="text-lg font-normal text-blue-200">/mo</span></p>
        </div>
        <div class="flex gap-6 text-right">
            {% if total_rent.section8 > 0 %}
            <div>
                <p class="text-blue-200 text-xs">Section 8</p>
                <p class="text-white text-lg font-semibold">${{ "{:,.0f}".format(total_rent.section8) }}</p>
            </div>
            {% endif %}
            {% if total_rent.regular > 0 %}
            <div>
                <p class="text-blue-200 text-xs">Regular</p>
                <p class="text-white text-lg font-semibold">${{ "{:,.0f}".format(total_rent.regular) }}</p>
            </div>
            {% endif %}
            <div>
                <p class="text-blue-200 text-xs">Properties</p>
                <p class="text-white text-lg font-semibold">{{ total_rent.count }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Filters - Clean and minimal -->
<div class="bg-white shadow rounded-lg mb-6 px-4 py-3">
    <form method="GET" class="flex flex-wrap gap-3 items-center">
        <div class="flex-1 min-w-[200px] max-w-md">
            <input type="text" name="search" id="search" value="{{ search }}" placeholder="Search properties..."
                   class="block w-full rounded-md border-0 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 text-sm px-3">
        </div>

        <!-- Quick Filter: Needs Attention -->
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-md cursor-pointer hover:bg-gray-50 {% if status_filter == 'attention' %}bg-amber-50 ring-1 ring-amber-200{% endif %}">
            <input type="checkbox" name="status" value="attention" {% if status_filter == 'attention' %}checked{% endif %} onchange="this.form.submit()"
                   class="h-4 w-4 rounded border-gray-300 text-amber-600 focus:ring-amber-500">
            <span class="text-sm text-gray-700">Needs Attention</span>
        </label>

        <!-- Status Dropdown - Secondary -->
        <select name="status" id="status" onchange="this.form.submit()" class="rounded-md border-0 py-2 text-sm text-gray-600 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600 px-3 bg-white">
            <option value="">All Active</option>
            <option value="attention" {% if status_filter == 'attention' %}selected{% endif %}>Needs Attention</option>
            <option value="vacant" {% if status_filter == 'vacant' %}selected{% endif %}>Vacant</option>
            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
        </select>

        {% if search or status_filter %}
        <a href="/properties" class="text-sm text-gray-500 hover:text-gray-700">Clear</a>
        {% endif %}
    </form>
</div>

<!-- Properties list -->
<div class="bg-white shadow rounded-lg overflow-hidden">
    {% if properties %}
    <table class="min-w-full">
        <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tenant</th>
                <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Status</th>
                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-28">Rent</th>
                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-28">Water Bill</th>
                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-16"></th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
            {% for item in properties %}
            {# Compute operational status #}
            {% set active_tenants = item.property.tenants | selectattr('is_active', 'true') | list %}
            {% set is_vacant = active_tenants | length == 0 %}
            {% set no_license = not item.property.has_rental_license %}
            {% set failed_inspection = item.property.section8_inspection_status == 'failed' %}
            {% set has_section8 = active_tenants | selectattr('is_section8', 'true') | list | length > 0 %}
            {% set needs_attention = is_vacant or no_license or failed_inspection %}

            {# Determine computed status #}
            {% if not item.property.is_active %}
                {% set op_status = 'inactive' %}
            {% elif failed_inspection %}
                {% set op_status = 'issue' %}
            {% elif is_vacant or no_license %}
                {% set op_status = 'attention' %}
            {% else %}
                {% set op_status = 'ok' %}
            {% endif %}

            <tr class="hover:bg-gray-50 transition-colors">
                <!-- Property Info -->
                <td class="px-6 py-4">
                    <div class="flex items-start gap-2">
                        <span class="text-lg">ğŸ </span>
                        <div>
                            <a href="/properties/{{ item.property.id }}" class="text-sm font-medium text-blue-600 hover:text-blue-500">
                                {{ item.property.address }}{% if item.property.city %}, {{ item.property.city }}{% endif %}{% if item.property.state %}, {{ item.property.state }}{% endif %}{% if item.property.zip_code %} {{ item.property.zip_code }}{% endif %}
                            </a>
                            <!-- Tags: Max 3, ordered: Occupancy Â· Compliance Â· Section 8 -->
                            <div class="flex flex-wrap items-center gap-1.5 mt-1.5">
                                {# Tag 1: Occupancy #}
                                {% if is_vacant %}
                                <span class="inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700">
                                    ğŸ”‘ Vacant
                                </span>
                                {% else %}
                                <span class="inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-700">
                                    ğŸ‘¥ Occupied ({{ active_tenants|length }})
                                </span>
                                {% endif %}

                                {# Tag 2: Compliance #}
                                {% if no_license %}
                                <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">
                                    ğŸ“œ No License
                                </span>
                                {% elif item.property.has_rental_license %}
                                <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-700">
                                    ğŸ“œ Licensed
                                </span>
                                {% endif %}

                                {# Tag 3: Section 8 (optional) #}
                                {% if has_section8 %}
                                <span class="inline-flex items-center rounded-full bg-purple-100 px-2 py-0.5 text-xs font-medium text-purple-700">
                                    ğŸ›ï¸ Section 8
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </td>

                <!-- Tenant -->
                <td class="px-4 py-4">
                    {% if active_tenants %}
                    {% set primary_tenant = active_tenants | selectattr('is_primary', 'true') | first %}
                    {% set display_tenant = primary_tenant if primary_tenant else active_tenants[0] %}
                    <div class="text-sm text-gray-900">{{ display_tenant.name }}</div>
                    {% if active_tenants|length > 1 %}
                    <div class="text-xs text-gray-400">+{{ active_tenants|length - 1 }} more</div>
                    {% endif %}
                    {% else %}
                    <span class="text-sm text-gray-300">â€”</span>
                    {% endif %}
                </td>

                <!-- Property Details -->
                <td class="px-4 py-4 text-center">
                    <div class="text-xs text-gray-500 space-y-0.5">
                        {% if item.property.bedrooms or item.property.bathrooms %}
                        <div>
                            {% if item.property.bedrooms %}<span class="font-medium">{{ item.property.bedrooms }}</span> bd{% endif %}
                            {% if item.property.bedrooms and item.property.bathrooms %} Â· {% endif %}
                            {% if item.property.bathrooms %}<span class="font-medium">{{ item.property.bathrooms|int if item.property.bathrooms == item.property.bathrooms|int else item.property.bathrooms }}</span> ba{% endif %}
                        </div>
                        {% endif %}
                        {% if item.property.square_feet %}
                        <div><span class="font-medium">{{ "{:,}".format(item.property.square_feet) }}</span> sf</div>
                        {% endif %}
                        {% if item.property.year_built %}
                        <div class="text-gray-400">{{ item.property.year_built }}</div>
                        {% endif %}
                        {% if not item.property.bedrooms and not item.property.bathrooms and not item.property.square_feet and not item.property.year_built %}
                        <span class="text-gray-300">â€”</span>
                        {% endif %}
                    </div>
                </td>

                <!-- Computed Status Chip -->
                <td class="px-4 py-4 text-center">
                    {% if op_status == 'inactive' %}
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-gray-100" title="Inactive">
                        <span class="text-sm">âšª</span>
                    </span>
                    {% elif op_status == 'issue' %}
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-red-100" title="Issue - Needs action">
                        <span class="text-sm">ğŸ”´</span>
                    </span>
                    {% elif op_status == 'attention' %}
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-amber-100" title="Attention needed">
                        <span class="text-sm">ğŸŸ¡</span>
                    </span>
                    {% else %}
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-green-100" title="OK">
                        <span class="text-sm">ğŸŸ¢</span>
                    </span>
                    {% endif %}
                </td>

                <!-- Rent -->
                <td class="px-4 py-4 text-right">
                    {% if active_tenants %}
                    {% set primary_tenant = active_tenants | selectattr('is_primary', 'true') | first %}
                    {% set rent_tenant = primary_tenant if primary_tenant else active_tenants[0] %}
                    {% if rent_tenant.is_section8 and (rent_tenant.voucher_amount or rent_tenant.tenant_portion) %}
                        {% set voucher = rent_tenant.voucher_amount|float if rent_tenant.voucher_amount else 0 %}
                        {% set portion = rent_tenant.tenant_portion|float if rent_tenant.tenant_portion else 0 %}
                        {% set total_rent = voucher + portion %}
                        <div class="text-sm font-semibold text-gray-900">${{ "%.0f"|format(total_rent) }}<span class="text-xs font-normal text-gray-400">/mo</span></div>
                        <div class="text-xs text-gray-400" title="Voucher: ${{ "%.0f"|format(voucher) }} + Tenant: ${{ "%.0f"|format(portion) }}">
                            S8: ${{ "%.0f"|format(voucher) }} + ${{ "%.0f"|format(portion) }}
                        </div>
                    {% elif rent_tenant.current_rent %}
                        <div class="text-sm font-semibold text-gray-900">${{ "%.0f"|format(rent_tenant.current_rent|float) }}<span class="text-xs font-normal text-gray-400">/mo</span></div>
                    {% else %}
                        <span class="text-sm text-gray-300">â€”</span>
                    {% endif %}
                    {% else %}
                    <span class="text-sm text-gray-300">â€”</span>
                    {% endif %}
                </td>

                <!-- Water Bill -->
                <td class="px-4 py-4 text-right">
                    {% if item.property.bills and item.property.bills[0].amount_due %}
                    {% set amount = item.property.bills[0].amount_due %}
                    <span class="text-sm {% if amount > 100 %}text-gray-700{% else %}text-gray-400{% endif %} font-light">
                        ğŸ’§ ${{ "%.0f"|format(amount) }}
                    </span>
                    {% else %}
                    <span class="text-sm text-gray-300">â€”</span>
                    {% endif %}
                </td>

                <!-- Actions -->
                <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a href="/listings/{{ item.property.id }}" target="_blank" class="text-gray-500 hover:text-blue-600 mr-3" title="View public listing">ğŸŒ</a>
                    <a href="/properties/{{ item.property.id }}" class="text-blue-600 hover:text-blue-900 mr-3">View</a>
                    <a href="/properties/{{ item.property.id }}/edit" class="text-gray-600 hover:text-gray-900 mr-3">Edit</a>
                    <form action="/properties/{{ item.property.id }}/delete" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to delete this property?');">
                        <button type="submit" class="text-red-600 hover:text-red-900">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Summary footer -->
    <div class="px-6 py-3 bg-gray-50 border-t border-gray-200 text-xs text-gray-500">
        {{ properties|length }} propert{{ 'y' if properties|length == 1 else 'ies' }}
    </div>

    {% else %}
    <div class="text-center py-16">
        <div class="text-4xl mb-3">ğŸ </div>
        <h3 class="text-sm font-medium text-gray-900">No properties found</h3>
        <p class="mt-1 text-sm text-gray-500">Get started by adding your first property.</p>
        <div class="mt-4">
            <a href="/properties/new" class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">
                Add Property
            </a>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

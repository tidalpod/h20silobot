{% extends "base.html" %}

{% block title %}Properties{% endblock %}

{% block header %}
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8 flex justify-between items-center">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900">Properties</h1>
        <a href="/properties/new" class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">
            <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            Add Property
        </a>
    </div>
</header>
{% endblock %}

{% block content %}
<!-- Filters - Clean and minimal -->
<div class="bg-white shadow rounded-lg mb-6 px-4 py-3">
    <form method="GET" class="flex flex-wrap gap-3 items-center">
        <div class="flex-1 min-w-[200px] max-w-md">
            <input type="text" name="search" id="search" value="{{ search }}" placeholder="Search properties..."
                   class="block w-full rounded-md border-0 py-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 text-sm px-3">
        </div>

        <!-- Quick Filter: Needs Attention -->
        <label class="inline-flex items-center gap-2 px-3 py-2 rounded-md cursor-pointer hover:bg-gray-50 {% if status_filter == 'attention' %}bg-amber-50 ring-1 ring-amber-200{% endif %}">
            <input type="checkbox" name="status" value="attention" {% if status_filter == 'attention' %}checked{% endif %} onchange="this.form.submit()"
                   class="h-4 w-4 rounded border-gray-300 text-amber-600 focus:ring-amber-500">
            <span class="text-sm text-gray-700">Needs Attention</span>
        </label>

        <!-- Status Dropdown - Secondary -->
        <select name="status" id="status" onchange="this.form.submit()" class="rounded-md border-0 py-2 text-sm text-gray-600 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-blue-600 px-3 bg-white">
            <option value="">All Active</option>
            <option value="attention" {% if status_filter == 'attention' %}selected{% endif %}>Needs Attention</option>
            <option value="vacant" {% if status_filter == 'vacant' %}selected{% endif %}>Vacant</option>
            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
        </select>

        {% if search or status_filter %}
        <a href="/properties" class="text-sm text-gray-500 hover:text-gray-700">Clear</a>
        {% endif %}
    </form>
</div>

<!-- Properties list -->
<div class="bg-white shadow rounded-lg overflow-hidden">
    {% if properties %}
    <table class="min-w-full">
        <thead class="bg-gray-50 border-b border-gray-200">
            <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Status</th>
                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-28">Balance</th>
                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-16"></th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
            {% for item in properties %}
            {# Compute operational status #}
            {% set active_tenants = item.property.tenants | selectattr('is_active', 'true') | list %}
            {% set is_vacant = active_tenants | length == 0 %}
            {% set no_license = not item.property.has_rental_license %}
            {% set failed_inspection = item.property.section8_inspection_status == 'failed' %}
            {% set has_section8 = active_tenants | selectattr('is_section8', 'true') | list | length > 0 %}
            {% set needs_attention = is_vacant or no_license or failed_inspection %}

            {# Determine computed status #}
            {% if not item.property.is_active %}
                {% set op_status = 'inactive' %}
            {% elif failed_inspection %}
                {% set op_status = 'issue' %}
            {% elif is_vacant or no_license %}
                {% set op_status = 'attention' %}
            {% else %}
                {% set op_status = 'ok' %}
            {% endif %}

            <tr class="hover:bg-gray-50 transition-colors">
                <!-- Property Info -->
                <td class="px-6 py-4">
                    <div class="flex items-start gap-3">
                        <a href="/properties/{{ item.property.id }}" class="text-sm font-medium text-gray-900 hover:text-blue-600">
                            {{ item.property.address }}
                        </a>
                    </div>
                    <!-- Tags: Max 3, ordered: Occupancy ¬∑ Compliance ¬∑ Section 8 -->
                    <div class="flex items-center gap-1.5 mt-1.5 text-xs">
                        {# Tag 1: Occupancy #}
                        {% if is_vacant %}
                        <span class="text-amber-600">Vacant</span>
                        {% else %}
                        <span class="text-gray-500">Occupied</span>
                        {% endif %}

                        {# Tag 2: Compliance #}
                        {% if no_license %}
                        <span class="text-gray-300">¬∑</span>
                        <span class="text-amber-600">No License</span>
                        {% elif item.property.has_city_certification %}
                        <span class="text-gray-300">¬∑</span>
                        <span class="text-gray-500">Certified</span>
                        {% endif %}

                        {# Tag 3: Section 8 (optional) #}
                        {% if has_section8 %}
                        <span class="text-gray-300">¬∑</span>
                        <span class="text-purple-600">S8</span>
                        {% endif %}
                    </div>
                    <!-- Account number - muted, small -->
                    <p class="text-[11px] text-gray-400 mt-1" title="BSA Account: {{ item.property.bsa_account_number }}">
                        {{ item.property.bsa_account_number }}
                    </p>
                </td>

                <!-- Computed Status Chip -->
                <td class="px-4 py-4 text-center">
                    {% if op_status == 'inactive' %}
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-gray-100" title="Inactive">
                        <span class="text-sm">‚ö™</span>
                    </span>
                    {% elif op_status == 'issue' %}
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-red-100" title="Issue - Needs action">
                        <span class="text-sm">üî¥</span>
                    </span>
                    {% elif op_status == 'attention' %}
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-amber-100" title="Attention needed">
                        <span class="text-sm">üü°</span>
                    </span>
                    {% else %}
                    <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-green-100" title="OK">
                        <span class="text-sm">üü¢</span>
                    </span>
                    {% endif %}
                </td>

                <!-- Amount Due - De-emphasized -->
                <td class="px-4 py-4 text-right">
                    {% if item.property.bills and item.property.bills[0].amount_due %}
                    {% set amount = item.property.bills[0].amount_due %}
                    <span class="text-sm {% if amount > 100 %}text-gray-700{% else %}text-gray-400{% endif %} font-light">
                        ${{ "%.0f"|format(amount) }}
                    </span>
                    {% else %}
                    <span class="text-sm text-gray-300">‚Äî</span>
                    {% endif %}
                </td>

                <!-- Actions - Minimal -->
                <td class="px-4 py-4 text-right">
                    <div class="flex items-center justify-end gap-1">
                        <!-- Primary: View -->
                        <a href="/properties/{{ item.property.id }}" class="p-1.5 text-gray-400 hover:text-blue-600 rounded hover:bg-gray-100" title="View">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </a>
                        <!-- Secondary: Menu -->
                        <div class="relative" x-data="{ open: false }">
                            <button @click="open = !open" class="p-1.5 text-gray-400 hover:text-gray-600 rounded hover:bg-gray-100" title="More actions">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
                                </svg>
                            </button>
                            <div x-show="open" @click.away="open = false" x-cloak
                                 class="absolute right-0 mt-1 w-32 rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1">
                                    <a href="/properties/{{ item.property.id }}/edit" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Edit</a>
                                    <a href="/notifications/compose?property_id={{ item.property.id }}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Notify</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Summary footer -->
    <div class="px-6 py-3 bg-gray-50 border-t border-gray-200 text-xs text-gray-500">
        {{ properties|length }} propert{{ 'y' if properties|length == 1 else 'ies' }}
    </div>

    {% else %}
    <div class="text-center py-16">
        <div class="text-4xl mb-3">üè†</div>
        <h3 class="text-sm font-medium text-gray-900">No properties found</h3>
        <p class="mt-1 text-sm text-gray-500">Get started by adding your first property.</p>
        <div class="mt-4">
            <a href="/properties/new" class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">
                Add Property
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Alpine.js for dropdown (if not already included) -->
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<style>[x-cloak] { display: none !important; }</style>
{% endblock %}

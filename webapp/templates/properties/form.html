{% extends "base.html" %}

{% block title %}{% if property %}Edit Property{% else %}Add Property{% endif %}{% endblock %}

{% block header %}
<header class="bg-white shadow-sm">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <nav class="flex mb-2" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2">
                <li><a href="/properties" class="text-sm text-gray-500 hover:text-gray-700">ğŸ  Properties</a></li>
                <li><span class="text-gray-400">/</span></li>
                <li class="text-sm text-gray-900">{% if property %}Edit{% else %}Add New{% endif %}</li>
            </ol>
        </nav>
        <h1 class="text-3xl font-bold tracking-tight text-gray-900 flex items-center gap-2">
            {% if property %}âœï¸ Edit Property{% else %}â• Add New Property{% endif %}
        </h1>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="bg-white shadow-sm rounded-xl border border-gray-200">
    <form action="{% if property %}/properties/{{ property.id }}/edit{% else %}/properties/new{% endif %}" method="POST" class="p-6">
        {% if error %}
        <div class="mb-6 rounded-xl bg-red-50 p-4 border border-red-200">
            <div class="flex items-center gap-3">
                <span class="text-xl">âŒ</span>
                <p class="text-sm font-medium text-red-800">{{ error }}</p>
            </div>
        </div>
        {% endif %}

        <div class="space-y-8">
            <!-- Address Section -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2 mb-4">
                    <span>ğŸ“</span> Address
                </h2>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-6">
                    <div class="sm:col-span-4">
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Street Address *</label>
                        <div class="flex gap-2">
                            <input type="text" name="address" id="address" required
                                   value="{{ property.address if property else '' }}"
                                   placeholder="123 Main St"
                                   class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                            <button type="button" onclick="lookupProperty()"
                                    class="inline-flex items-center rounded-lg bg-gradient-to-r from-purple-600 to-purple-500 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:from-purple-500 hover:to-purple-400 transition-all whitespace-nowrap">
                                <span class="mr-2">ğŸ”</span> Lookup
                            </button>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Enter full address and click Lookup to auto-fill property details</p>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                        <input type="text" name="city" id="city"
                               value="{{ property.city if property else 'Detroit' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                    <div class="sm:col-span-1">
                        <label for="state" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                        <input type="text" name="state" id="state" maxlength="2"
                               value="{{ property.state if property else 'MI' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5 uppercase">
                    </div>
                    <div class="sm:col-span-1">
                        <label for="zip_code" class="block text-sm font-medium text-gray-700 mb-1">ZIP</label>
                        <input type="text" name="zip_code" id="zip_code"
                               value="{{ property.zip_code if property else '' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                </div>
            </div>

            <!-- Property Details Section -->
            <div id="property-details-section">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2 mb-4">
                    <span>ğŸ¡</span> Property Details
                    <span id="lookup-status" class="hidden text-sm font-normal text-green-600"></span>
                </h2>
                <div class="grid grid-cols-2 gap-4 sm:grid-cols-6">
                    <div class="sm:col-span-1">
                        <label for="bedrooms" class="block text-sm font-medium text-gray-700 mb-1">ğŸ›ï¸ Beds</label>
                        <input type="number" name="bedrooms" id="bedrooms" min="0"
                               value="{{ property.bedrooms if property else '' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                    <div class="sm:col-span-1">
                        <label for="bathrooms" class="block text-sm font-medium text-gray-700 mb-1">ğŸš¿ Baths</label>
                        <input type="number" name="bathrooms" id="bathrooms" min="0" step="0.5"
                               value="{{ property.bathrooms if property else '' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                    <div class="sm:col-span-2">
                        <label for="square_feet" class="block text-sm font-medium text-gray-700 mb-1">ğŸ“ Sq Ft</label>
                        <input type="number" name="square_feet" id="square_feet" min="0"
                               value="{{ property.square_feet if property else '' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                    <div class="sm:col-span-1">
                        <label for="year_built" class="block text-sm font-medium text-gray-700 mb-1">ğŸ“… Year</label>
                        <input type="number" name="year_built" id="year_built" min="1800" max="2030"
                               value="{{ property.year_built if property else '' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                    <div class="sm:col-span-1">
                        <label for="property_type" class="block text-sm font-medium text-gray-700 mb-1">ğŸ  Type</label>
                        <select name="property_type" id="property_type"
                                class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                            <option value="">Select...</option>
                            <option value="Single Family" {% if property and property.property_type == 'Single Family' %}selected{% endif %}>Single Family</option>
                            <option value="Multi-Family" {% if property and property.property_type == 'Multi-Family' %}selected{% endif %}>Multi-Family</option>
                            <option value="Condo" {% if property and property.property_type == 'Condo' %}selected{% endif %}>Condo</option>
                            <option value="Townhouse" {% if property and property.property_type == 'Townhouse' %}selected{% endif %}>Townhouse</option>
                            <option value="Duplex" {% if property and property.property_type == 'Duplex' %}selected{% endif %}>Duplex</option>
                            <option value="Other" {% if property and property.property_type == 'Other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    <div class="sm:col-span-2">
                        <label for="lot_size" class="block text-sm font-medium text-gray-700 mb-1">ğŸŒ³ Lot Size</label>
                        <input type="text" name="lot_size" id="lot_size"
                               value="{{ property.lot_size if property else '' }}"
                               placeholder="e.g., 0.25 acres"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                </div>
            </div>

            <!-- Account Numbers Section -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2 mb-4">
                    <span>ğŸ“‹</span> Account Numbers
                </h2>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <label for="bsa_account_number" class="block text-sm font-medium text-gray-700 mb-1">BSA Account Number *</label>
                        <input type="text" name="bsa_account_number" id="bsa_account_number" required
                               value="{{ property.bsa_account_number if property else '' }}"
                               placeholder="Enter BSA account number"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                        <p class="mt-1 text-xs text-gray-500">The account number from BSA Online for water bills</p>
                    </div>
                    <div>
                        <label for="parcel_number" class="block text-sm font-medium text-gray-700 mb-1">Parcel Number</label>
                        <input type="text" name="parcel_number" id="parcel_number"
                               value="{{ property.parcel_number if property else '' }}"
                               placeholder="Optional parcel ID"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                </div>
            </div>

            <!-- Owner & Tenant Section -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2 mb-4">
                    <span>ğŸ‘¥</span> Owner & Tenant
                </h2>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <label for="owner_name" class="block text-sm font-medium text-gray-700 mb-1">Owner Name</label>
                        <input type="text" name="owner_name" id="owner_name"
                               value="{{ property.owner_name if property else '' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                    <div>
                        <label for="tenant_name" class="block text-sm font-medium text-gray-700 mb-1">Tenant Name</label>
                        <input type="text" name="tenant_name" id="tenant_name"
                               value="{{ property.tenant_name if property else '' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                        <p class="mt-1 text-xs text-gray-500">For detailed tenant tracking, use the Tenants section</p>
                    </div>
                </div>
            </div>

            <!-- Occupancy Status Section -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2 mb-4">
                    <span>ğŸ </span> Occupancy Status
                </h2>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="is_vacant" value="true"
                                   {% if property and property.is_vacant %}checked{% endif %}
                                   class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                            <span class="ml-2 text-sm text-gray-900">Currently Vacant</span>
                        </label>
                        <p class="mt-1 text-xs text-gray-500 ml-6">Check if the property has no tenants</p>
                    </div>
                </div>
            </div>

            <!-- City Certification Section -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2 mb-4">
                    <span>ğŸ›ï¸</span> City Certification
                </h2>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="has_city_certification" value="true"
                                   {% if property and property.has_city_certification %}checked{% endif %}
                                   class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-600">
                            <span class="ml-2 text-sm text-gray-900">Has City Certification</span>
                        </label>
                    </div>
                    <div>
                        <label for="city_certification_date" class="block text-sm font-medium text-gray-700 mb-1">Certification Date</label>
                        <input type="date" name="city_certification_date" id="city_certification_date"
                               value="{{ property.city_certification_date.isoformat() if property and property.city_certification_date else '' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                    <div>
                        <label for="city_certification_expiry" class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                        <input type="date" name="city_certification_expiry" id="city_certification_expiry"
                               value="{{ property.city_certification_expiry.isoformat() if property and property.city_certification_expiry else '' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                </div>
            </div>

            <!-- Rental License Section -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2 mb-4">
                    <span>ğŸ“œ</span> Rental License
                </h2>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-4">
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="has_rental_license" value="true"
                                   {% if property and property.has_rental_license %}checked{% endif %}
                                   class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-600">
                            <span class="ml-2 text-sm text-gray-900">Has Rental License</span>
                        </label>
                    </div>
                    <div>
                        <label for="rental_license_number" class="block text-sm font-medium text-gray-700 mb-1">License Number</label>
                        <input type="text" name="rental_license_number" id="rental_license_number"
                               value="{{ property.rental_license_number if property else '' }}"
                               placeholder="License #"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                    <div>
                        <label for="rental_license_issued" class="block text-sm font-medium text-gray-700 mb-1">Issued Date</label>
                        <input type="date" name="rental_license_issued" id="rental_license_issued"
                               value="{{ property.rental_license_issued.isoformat() if property and property.rental_license_issued else '' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                    <div>
                        <label for="rental_license_expiry" class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                        <input type="date" name="rental_license_expiry" id="rental_license_expiry"
                               value="{{ property.rental_license_expiry.isoformat() if property and property.rental_license_expiry else '' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                </div>
            </div>

            <!-- Section 8 Inspection Section -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2 mb-4">
                    <span>ğŸ”</span> Section 8 Inspection
                </h2>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                    <div>
                        <label for="section8_inspection_status" class="block text-sm font-medium text-gray-700 mb-1">Inspection Status</label>
                        <select name="section8_inspection_status" id="section8_inspection_status"
                                class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                            <option value="">Not Applicable</option>
                            <option value="scheduled" {% if property and property.section8_inspection_status == 'scheduled' %}selected{% endif %}>ğŸ“… Scheduled</option>
                            <option value="pending" {% if property and property.section8_inspection_status == 'pending' %}selected{% endif %}>â³ Pending</option>
                            <option value="passed" {% if property and property.section8_inspection_status == 'passed' %}selected{% endif %}>âœ… Passed</option>
                            <option value="failed" {% if property and property.section8_inspection_status == 'failed' %}selected{% endif %}>âŒ Failed</option>
                            <option value="reinspection" {% if property and property.section8_inspection_status == 'reinspection' %}selected{% endif %}>ğŸ”„ Re-inspection Needed</option>
                        </select>
                    </div>
                    <div>
                        <label for="section8_inspection_date" class="block text-sm font-medium text-gray-700 mb-1">Inspection Date</label>
                        <input type="date" name="section8_inspection_date" id="section8_inspection_date"
                               value="{{ property.section8_inspection_date.isoformat() if property and property.section8_inspection_date else '' }}"
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                    <div>
                        <label for="section8_inspection_notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <input type="text" name="section8_inspection_notes" id="section8_inspection_notes"
                               value="{{ property.section8_inspection_notes if property else '' }}"
                               placeholder="Inspection notes..."
                               class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2.5">
                    </div>
                </div>
            </div>

            {% if property %}
            <!-- Status Section -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2 mb-4">
                    <span>âš™ï¸</span> Status
                </h2>
                <label class="flex items-center">
                    <input type="checkbox" name="is_active" value="true"
                           {% if property.is_active %}checked{% endif %}
                           class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
                    <span class="ml-2 text-sm text-gray-900">Active</span>
                </label>
                <p class="mt-1 text-xs text-gray-500 ml-6">Inactive properties won't appear in the main list or be scraped</p>
            </div>
            {% endif %}
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200 flex items-center justify-between">
            {% if property %}
            <div class="flex gap-2">
                <button type="button" onclick="deactivateProperty()" class="inline-flex items-center rounded-lg bg-yellow-100 px-4 py-2 text-sm font-semibold text-yellow-700 hover:bg-yellow-200 transition-all">
                    <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                    </svg>
                    Deactivate
                </button>
                <button type="button" onclick="deletePropertyPermanent()" class="inline-flex items-center rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 transition-all">
                    <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                    </svg>
                    Delete
                </button>
            </div>
            {% else %}
            <div></div>
            {% endif %}
            <div class="flex gap-3">
                <a href="{% if property %}/properties/{{ property.id }}{% else %}/properties{% endif %}" class="px-4 py-2 text-sm font-semibold text-gray-700 hover:text-gray-900">Cancel</a>
                <button type="submit" class="rounded-xl bg-gradient-to-r from-blue-600 to-blue-500 px-6 py-2.5 text-sm font-semibold text-white shadow-sm hover:from-blue-500 hover:to-blue-400 transition-all">
                    {% if property %}ğŸ’¾ Save Changes{% else %}â• Add Property{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Lookup Loading Modal -->
<div id="lookup-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"></div>
        <p class="mt-4 text-gray-700 font-medium">ğŸ” Looking up property details...</p>
        <p class="text-sm text-gray-500 mt-1">This may take a few seconds</p>
    </div>
</div>

<script>
// Auto-parse address when pasting or typing
function parseAddress() {
    const addressField = document.getElementById('address');
    const fullAddress = addressField.value.trim();

    if (!fullAddress) return;

    // Pattern: "Street, City, State ZIP" or "Street, City, State"
    // Examples: "22025 Linwood Ave, Eastpointe, MI 48021"
    //           "123 Main St, Detroit, MI"

    const patterns = [
        // Street, City, State ZIP
        /^(.+?),\s*([^,]+),\s*([A-Z]{2})\s*(\d{5}(?:-\d{4})?)$/i,
        // Street, City, State (no zip)
        /^(.+?),\s*([^,]+),\s*([A-Z]{2})$/i,
        // Street City State ZIP (no commas)
        /^(.+?)\s+([A-Za-z\s]+),?\s*([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/i,
    ];

    for (const pattern of patterns) {
        const match = fullAddress.match(pattern);
        if (match) {
            const street = match[1].trim();
            const city = match[2].trim();
            const state = match[3].toUpperCase();
            const zip = match[4] ? match[4].trim() : '';

            // Update fields
            addressField.value = street;
            document.getElementById('city').value = city;
            document.getElementById('state').value = state;
            if (zip) {
                document.getElementById('zip_code').value = zip;
            }

            console.log(`Parsed address: street="${street}", city="${city}", state="${state}", zip="${zip}"`);
            return;
        }
    }
}

// Listen for paste and blur events on address field
document.addEventListener('DOMContentLoaded', function() {
    const addressField = document.getElementById('address');

    // Parse on paste (with small delay to let the value populate)
    addressField.addEventListener('paste', function() {
        setTimeout(parseAddress, 100);
    });

    // Also parse when leaving the field
    addressField.addEventListener('blur', parseAddress);
});

{% if property %}
function deactivateProperty() {
    if (confirm('Are you sure you want to deactivate this property? It will be hidden but can be restored.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/properties/{{ property.id }}/delete';
        document.body.appendChild(form);
        form.submit();
    }
}

function deletePropertyPermanent() {
    if (confirm('âš ï¸ PERMANENT DELETE âš ï¸\n\nThis will permanently remove this property and ALL associated data (bills, tenants, etc.).\n\nThis action CANNOT be undone.\n\nAre you absolutely sure?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/properties/{{ property.id }}/delete-permanent';
        document.body.appendChild(form);
        form.submit();
    }
}
{% endif %}

async function lookupProperty() {
    // First parse the address to extract city/state/zip
    parseAddress();

    const address = document.getElementById('address').value.trim();
    const city = document.getElementById('city').value.trim() || 'Detroit';
    const state = document.getElementById('state').value.trim() || 'MI';

    if (!address) {
        alert('Please enter an address first');
        return;
    }

    // Show loading modal
    document.getElementById('lookup-modal').classList.remove('hidden');

    try {
        const fullAddress = `${address}, ${city}, ${state}`;
        const response = await fetch(`/api/property-lookup?address=${encodeURIComponent(fullAddress)}`);
        const data = await response.json();

        if (data.success) {
            // Fill in the fields
            if (data.bedrooms) document.getElementById('bedrooms').value = data.bedrooms;
            if (data.bathrooms) document.getElementById('bathrooms').value = data.bathrooms;
            if (data.square_feet) document.getElementById('square_feet').value = data.square_feet;
            if (data.year_built) document.getElementById('year_built').value = data.year_built;
            if (data.lot_size) document.getElementById('lot_size').value = data.lot_size;
            if (data.property_type) {
                const select = document.getElementById('property_type');
                for (let option of select.options) {
                    if (option.value === data.property_type) {
                        option.selected = true;
                        break;
                    }
                }
            }
            if (data.zip_code) document.getElementById('zip_code').value = data.zip_code;

            // Show success message
            const status = document.getElementById('lookup-status');
            status.textContent = 'âœ… Found!';
            status.classList.remove('hidden');
            setTimeout(() => status.classList.add('hidden'), 3000);
        } else {
            alert(data.message || 'Could not find property details. Please enter manually.');
        }
    } catch (error) {
        console.error('Lookup error:', error);
        alert('Error looking up property. Please enter details manually.');
    } finally {
        // Hide loading modal
        document.getElementById('lookup-modal').classList.add('hidden');
    }
}
</script>
{% endblock %}

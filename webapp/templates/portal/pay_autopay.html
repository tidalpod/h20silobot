{% extends "portal/base.html" %}

{% block title %}Autopay{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex items-center gap-2 mb-1">
        <a href="/portal/pay" class="text-blue-600 text-sm">&larr; Back</a>
    </div>
    <h1 class="text-2xl font-bold text-gray-900">Autopay</h1>
    <p class="text-sm text-gray-500 mt-1">Automatically pay rent each month</p>
</div>

<!-- Success/Error Messages -->
{% if success %}
<div class="mb-4 p-4 rounded-xl bg-green-50 border border-green-200">
    <p class="text-sm font-medium text-green-800">
        {% if success == 'enabled' %}Autopay enabled successfully!
        {% elif success == 'disabled' %}Autopay has been disabled.
        {% else %}{{ success }}{% endif %}
    </p>
</div>
{% endif %}

{% if error %}
<div class="mb-4 p-4 rounded-xl bg-red-50 border border-red-200">
    <p class="text-sm font-medium text-red-800">
        {% if error == 'no_bank' %}Please select a bank account.
        {% else %}{{ error }}{% endif %}
    </p>
</div>
{% endif %}

<!-- Current Status -->
<div class="portal-card p-5 mb-4">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-gray-900">Autopay Status</h2>
        {% if autopay and autopay.status.value == 'active' %}
        <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">Active</span>
        {% else %}
        <span class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-600">Inactive</span>
        {% endif %}
    </div>
    {% if autopay and autopay.status.value == 'active' %}
    <div class="text-sm text-gray-600 space-y-1">
        <p>Pays on the <strong>{{ autopay.pay_day }}{{ 'st' if autopay.pay_day == 1 else ('nd' if autopay.pay_day == 2 else ('rd' if autopay.pay_day == 3 else 'th')) }}</strong> of each month</p>
        {% if autopay.bank_account_ref %}
        <p>From: {{ autopay.bank_account_ref.institution_name }} ...{{ autopay.bank_account_ref.account_mask }}</p>
        {% endif %}
        {% if autopay.next_payment_date %}
        <p>Next payment: {{ autopay.next_payment_date.strftime('%b %d, %Y') }}</p>
        {% endif %}
    </div>
    {% endif %}
</div>

{% if not bank_accounts %}
<!-- No bank accounts -->
<div class="portal-card p-5 text-center">
    <span class="text-3xl block mb-2">&#127974;</span>
    <p class="text-sm font-medium text-gray-900 mb-1">Link a bank account first</p>
    <p class="text-xs text-gray-500 mb-3">You need a linked bank account to enable autopay</p>
    <a href="/portal/pay/bank" class="inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-500">
        Link Bank Account
    </a>
</div>
{% else %}
<!-- Autopay Form -->
<form method="POST" action="/portal/pay/autopay">
    <div class="portal-card p-5 mb-4">
        <h3 class="text-sm font-semibold text-gray-900 mb-3">Configure Autopay</h3>

        <!-- Bank Account -->
        <div class="mb-4">
            <label class="text-xs font-medium text-gray-600 block mb-2">Bank Account</label>
            {% for account in bank_accounts %}
            {% if account.is_active %}
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer mb-2 hover:bg-gray-50">
                <input type="radio" name="bank_account_id" value="{{ account.id }}"
                    {% if autopay and autopay.bank_account_id == account.id %}checked{% elif loop.first %}checked{% endif %}
                    class="text-blue-600">
                <div>
                    <p class="text-sm font-medium text-gray-900">{{ account.institution_name }}</p>
                    <p class="text-xs text-gray-500">{{ account.account_name }} ...{{ account.account_mask }}</p>
                </div>
            </label>
            {% endif %}
            {% endfor %}
        </div>

        <!-- Pay Day -->
        <div class="mb-4">
            <label class="text-xs font-medium text-gray-600 block mb-2">Pay Day of Month</label>
            <select name="pay_day" class="w-full p-3 rounded-lg border border-gray-200 text-sm">
                {% for d in range(1, 29) %}
                <option value="{{ d }}" {% if autopay and autopay.pay_day == d %}selected{% elif d == 1 and not autopay %}selected{% endif %}>
                    {{ d }}{{ 'st' if d == 1 else ('nd' if d == 2 else ('rd' if d == 3 else 'th')) }}
                </option>
                {% endfor %}
            </select>
            <p class="text-xs text-gray-400 mt-1">Rent amount will be your current rent + any applicable late fees</p>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="space-y-2">
        <button type="submit" name="action" value="enable" class="w-full py-3 rounded-xl bg-blue-600 text-white font-medium text-center hover:bg-blue-500 transition-colors">
            {% if autopay and autopay.status.value == 'active' %}Update Autopay{% else %}Enable Autopay{% endif %}
        </button>
        {% if autopay and autopay.status.value == 'active' %}
        <button type="submit" name="action" value="disable" class="w-full py-3 rounded-xl bg-white text-red-600 font-medium text-center border border-red-200 hover:bg-red-50 transition-colors">
            Disable Autopay
        </button>
        {% endif %}
    </div>
</form>
{% endif %}
{% endblock %}

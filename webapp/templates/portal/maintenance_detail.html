{% extends "portal/base.html" %}

{% block title %}Request #{{ wo.id }}{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="/portal/maintenance" class="text-sm text-blue-600 hover:text-blue-500">&larr; Back to requests</a>
</div>

<!-- Header -->
<div class="portal-card p-5 mb-4">
    <div class="flex items-center justify-between mb-3">
        <h1 class="text-lg font-bold text-gray-900">{{ wo.title }}</h1>
        <span class="text-xs text-gray-500">#{{ wo.id }}</span>
    </div>

    <!-- Status Progress Bar -->
    <div class="mb-4">
        {% set steps = ['new', 'assigned', 'in_progress', 'completed'] %}
        {% set current_idx = steps.index(wo.status.value) if wo.status.value in steps else 0 %}
        <div class="flex items-center gap-1">
            {% for step in steps %}
            {% set step_idx = loop.index0 %}
            <div class="flex-1">
                <div class="h-2 rounded-full {% if step_idx <= current_idx %}bg-blue-500{% else %}bg-gray-200{% endif %}"></div>
                <p class="text-xs mt-1 {% if step_idx == current_idx %}text-blue-600 font-medium{% else %}text-gray-400{% endif %}">
                    {{ step.replace('_', ' ').title() }}
                </p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Details -->
    <div class="space-y-2 text-sm">
        {% if wo.category %}
        <div class="flex justify-between">
            <span class="text-gray-500">Category</span>
            <span class="text-gray-900">{{ wo.category.value.replace('_', ' ').title() }}</span>
        </div>
        {% endif %}
        {% if wo.unit_area %}
        <div class="flex justify-between">
            <span class="text-gray-500">Area</span>
            <span class="text-gray-900">{{ wo.unit_area }}</span>
        </div>
        {% endif %}
        <div class="flex justify-between">
            <span class="text-gray-500">Submitted</span>
            <span class="text-gray-900">{{ wo.created_at.strftime('%b %d, %Y') }}</span>
        </div>
        {% if wo.scheduled_date %}
        <div class="flex justify-between">
            <span class="text-gray-500">Scheduled</span>
            <span class="text-gray-900 font-medium">{{ wo.scheduled_date.strftime('%b %d, %Y') }}</span>
        </div>
        {% endif %}
        {% if wo.completed_date %}
        <div class="flex justify-between">
            <span class="text-gray-500">Completed</span>
            <span class="text-green-600 font-medium">{{ wo.completed_date.strftime('%b %d, %Y') }}</span>
        </div>
        {% endif %}
    </div>
</div>

<!-- Description -->
{% if wo.description %}
<div class="portal-card p-5 mb-4">
    <h2 class="text-sm font-semibold text-gray-700 mb-2">Description</h2>
    <p class="text-sm text-gray-600 whitespace-pre-wrap">{{ wo.description }}</p>
</div>
{% endif %}

<!-- Resolution -->
{% if wo.resolution_notes %}
<div class="portal-card p-5 mb-4 bg-green-50 border-green-200">
    <h2 class="text-sm font-semibold text-green-800 mb-2">Resolution</h2>
    <p class="text-sm text-green-700 whitespace-pre-wrap">{{ wo.resolution_notes }}</p>
</div>
{% endif %}

<!-- Photos -->
<div class="portal-card p-5 mb-4">
    <h2 class="text-sm font-semibold text-gray-700 mb-3">Photos</h2>

    {% if wo.photos %}
    <div class="grid grid-cols-2 gap-2 mb-4">
        {% for photo in wo.photos %}
        <div class="relative">
            <img src="{{ photo.url }}" alt="Photo" class="w-full h-32 object-cover rounded-lg">
            {% if photo.uploaded_by_tenant %}
            <span class="absolute bottom-1 left-1 bg-blue-600 text-white text-xs px-1.5 py-0.5 rounded">You</span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Upload Form -->
    {% if wo.status.value not in ['completed', 'closed'] %}
    <form id="photo-upload-form" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center">
        <input type="file" id="photo-input" accept="image/*" class="hidden">
        <button type="button" onclick="document.getElementById('photo-input').click()" class="text-sm text-gray-600">
            <span class="text-xl block mb-1">ðŸ“·</span>
            Add a photo
        </button>
        <div id="upload-progress" class="hidden mt-2 text-sm text-blue-600">Uploading...</div>
    </form>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
const photoInput = document.getElementById('photo-input');
if (photoInput) {
    photoInput.addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const progress = document.getElementById('upload-progress');
        progress.classList.remove('hidden');

        const formData = new FormData();
        formData.append('photo', file);

        try {
            const res = await fetch('/portal/maintenance/{{ wo.id }}/photos/upload', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (data.success) {
                window.location.reload();
            } else {
                alert(data.error || 'Upload failed');
            }
        } catch (err) {
            alert('Upload failed: ' + err.message);
        } finally {
            progress.classList.add('hidden');
        }
    });
}
</script>
{% endblock %}

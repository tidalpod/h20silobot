{% extends "portal/base.html" %}

{% block title %}Pay Rent{% endblock %}

{% block head %}
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Pay Rent</h1>
    <p class="text-sm text-gray-500 mt-1">Make a one-time rent payment</p>
</div>

<!-- Success/Error Messages -->
{% if success %}
<div class="mb-4 p-4 rounded-xl bg-green-50 border border-green-200">
    <div class="flex items-center gap-2">
        <span class="text-green-600 text-lg">&#10003;</span>
        <p class="text-sm font-medium text-green-800">Payment submitted successfully! It may take 1-3 business days to process.</p>
    </div>
</div>
{% endif %}

{% if error %}
<div class="mb-4 p-4 rounded-xl bg-red-50 border border-red-200">
    <div class="flex items-center gap-2">
        <span class="text-red-600 text-lg">&#10007;</span>
        <p class="text-sm font-medium text-red-800">
            {% if error == 'no_bank' %}Please link a bank account first.
            {% elif error == 'already_paid' %}Rent has already been paid for this month.
            {% else %}{{ error }}{% endif %}
        </p>
    </div>
</div>
{% endif %}

<!-- Balance Due Card -->
<div class="portal-card p-5 mb-4">
    <div class="text-center mb-4">
        <p class="text-sm text-gray-500 mb-1">
            {% if balance.paid %}Paid for{% else %}Balance Due for{% endif %}
            {{ balance.payment_month.strftime('%B %Y') }}
        </p>
        <p class="text-4xl font-bold {% if balance.paid %}text-green-600{% elif balance.total_due > 0 %}text-gray-900{% else %}text-green-600{% endif %}">
            ${{ "{:,.2f}".format(balance.total_due) }}
        </p>
        {% if balance.paid %}
        <span class="inline-flex items-center mt-2 rounded-full bg-green-100 px-3 py-1 text-xs font-medium text-green-800">Paid</span>
        {% endif %}
    </div>

    {% if not balance.paid and balance.total_due > 0 %}
    <!-- Breakdown -->
    <div class="border-t border-gray-100 pt-3 space-y-2">
        <div class="flex justify-between text-sm">
            <span class="text-gray-500">Monthly Rent</span>
            <span class="text-gray-900 font-medium">${{ "{:,.2f}".format(balance.rent_amount) }}</span>
        </div>
        {% if balance.late_fee > 0 %}
        <div class="flex justify-between text-sm">
            <span class="text-red-500">Late Fee</span>
            <span class="text-red-600 font-medium">${{ "{:,.2f}".format(balance.late_fee) }}</span>
        </div>
        {% endif %}
        <div class="flex justify-between text-sm font-bold border-t border-gray-100 pt-2">
            <span>Total</span>
            <span>${{ "{:,.2f}".format(balance.total_due) }}</span>
        </div>
    </div>
    {% endif %}
</div>

<!-- Payment Form -->
{% if not balance.paid and balance.total_due > 0 %}
<form method="POST" action="/portal/pay" class="mb-4">
    {% if bank_accounts %}
    <!-- Linked Bank Account -->
    <div class="portal-card p-4 mb-4">
        <label class="text-sm font-medium text-gray-700 mb-2 block">Pay From</label>
        {% for account in bank_accounts %}
        {% if account.is_active %}
        <label class="flex items-center gap-3 p-3 rounded-lg border {% if loop.first %}border-blue-300 bg-blue-50{% else %}border-gray-200{% endif %} cursor-pointer mb-2">
            <input type="radio" name="bank_account_id" value="{{ account.id }}" {% if loop.first %}checked{% endif %} class="text-blue-600">
            <div class="flex-1">
                <p class="text-sm font-medium text-gray-900">{{ account.institution_name or 'Bank Account' }}</p>
                <p class="text-xs text-gray-500">{{ account.account_name }} ...{{ account.account_mask }}</p>
            </div>
        </label>
        {% endif %}
        {% endfor %}
    </div>

    <button type="submit" class="w-full py-3 rounded-xl bg-blue-600 text-white font-medium text-center hover:bg-blue-500 transition-colors">
        Pay ${{ "{:,.2f}".format(balance.total_due) }}
    </button>
    {% else %}
    <!-- No Bank Account Linked -->
    <div class="portal-card p-5 text-center mb-4">
        <span class="text-3xl block mb-2">&#127974;</span>
        <p class="text-sm font-medium text-gray-900 mb-1">No bank account linked</p>
        <p class="text-xs text-gray-500 mb-3">Link your bank account to pay rent online</p>
        <a href="/portal/pay/bank" class="inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium hover:bg-blue-500 transition-colors">
            Link Bank Account
        </a>
    </div>
    {% endif %}
</form>
{% endif %}

<!-- Recent Payment -->
{% if recent_payment %}
<div class="portal-card p-4 mb-4">
    <h3 class="text-sm font-semibold text-gray-900 mb-2">Most Recent Payment</h3>
    <div class="flex justify-between items-center">
        <div>
            <p class="text-sm text-gray-900">${{ "{:,.2f}".format(recent_payment.total_amount) }}</p>
            <p class="text-xs text-gray-500">{{ recent_payment.payment_month.strftime('%B %Y') }} &middot; {{ recent_payment.initiated_at.strftime('%b %d') }}</p>
        </div>
        {% if recent_payment.status.value == 'completed' %}
        <span class="inline-flex items-center rounded-full bg-green-100 px-2.5 py-0.5 text-xs font-medium text-green-800">Completed</span>
        {% elif recent_payment.status.value == 'processing' %}
        <span class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">Processing</span>
        {% elif recent_payment.status.value == 'pending' %}
        <span class="inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">Pending</span>
        {% elif recent_payment.status.value == 'failed' %}
        <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">Failed</span>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Quick Links -->
<div class="grid grid-cols-2 gap-3">
    <a href="/portal/pay/history" class="portal-card p-3 text-center hover:shadow-md transition-shadow">
        <span class="text-lg block">&#128196;</span>
        <span class="text-xs text-gray-600">History</span>
    </a>
    <a href="/portal/pay/autopay" class="portal-card p-3 text-center hover:shadow-md transition-shadow">
        <span class="text-lg block">&#128260;</span>
        <span class="text-xs text-gray-600">Autopay</span>
    </a>
</div>
{% endblock %}

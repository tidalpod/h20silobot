{% extends "portal/base.html" %}

{% block title %}Bank Account{% endblock %}

{% block head %}
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex items-center gap-2 mb-1">
        <a href="/portal/pay" class="text-blue-600 text-sm">&larr; Back</a>
    </div>
    <h1 class="text-2xl font-bold text-gray-900">Bank Account</h1>
    <p class="text-sm text-gray-500 mt-1">Link your bank account for rent payments</p>
</div>

<!-- Success/Error Messages -->
{% if success %}
<div class="mb-4 p-4 rounded-xl bg-green-50 border border-green-200">
    <p class="text-sm font-medium text-green-800">
        {% if success == 'unlinked' %}Bank account unlinked successfully.
        {% elif success == 'linked' %}Bank account linked successfully!
        {% else %}{{ success }}{% endif %}
    </p>
</div>
{% endif %}

{% if error %}
<div class="mb-4 p-4 rounded-xl bg-red-50 border border-red-200">
    <p class="text-sm font-medium text-red-800">{{ error }}</p>
</div>
{% endif %}

<!-- Linked Accounts -->
{% set active_accounts = bank_accounts | selectattr('is_active') | list %}
{% if active_accounts %}
<div class="space-y-3 mb-6">
    {% for account in active_accounts %}
    <div class="portal-card p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                    <span class="text-blue-600 text-lg">&#127974;</span>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-900">{{ account.institution_name or 'Bank Account' }}</p>
                    <p class="text-xs text-gray-500">{{ account.account_name }} &middot; ...{{ account.account_mask }}</p>
                </div>
            </div>
            <form method="POST" action="/portal/pay/bank/unlink" onsubmit="return confirm('Unlink this bank account?')">
                <input type="hidden" name="account_id" value="{{ account.id }}">
                <button type="submit" class="text-xs text-red-500 hover:text-red-700">Unlink</button>
            </form>
        </div>
        <p class="text-xs text-gray-400 mt-2">Linked {{ account.linked_at.strftime('%b %d, %Y') }}</p>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Link New Account Button -->
<button id="link-btn" onclick="openPlaidLink()" class="w-full portal-card p-4 text-center hover:shadow-md transition-shadow border-2 border-dashed border-gray-300 hover:border-blue-400">
    <span class="text-2xl block mb-1">&#43;</span>
    <span class="text-sm font-medium text-gray-700">Link Bank Account</span>
    <p class="text-xs text-gray-500 mt-1">Securely connect via Plaid</p>
</button>

<div class="mt-6 p-4 rounded-xl bg-gray-50 border border-gray-200">
    <p class="text-xs text-gray-500 text-center">
        Your bank credentials are securely handled by Plaid and never stored on our servers.
        Blue Deer only receives limited account information for payment processing.
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
async function openPlaidLink() {
    const btn = document.getElementById('link-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="text-sm text-gray-500">Loading...</span>';

    try {
        const resp = await fetch('/portal/pay/bank/link-token', { method: 'POST' });
        const data = await resp.json();

        if (data.error) {
            alert('Error: ' + data.error);
            location.reload();
            return;
        }

        const handler = Plaid.create({
            token: data.link_token,
            onSuccess: async (public_token, metadata) => {
                const result = await fetch('/portal/pay/bank/link-complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ public_token }),
                });
                const resultData = await result.json();
                if (resultData.success) {
                    window.location.href = '/portal/pay/bank?success=linked';
                } else {
                    alert('Error linking account: ' + (resultData.error || 'Unknown error'));
                    location.reload();
                }
            },
            onExit: () => {
                location.reload();
            },
        });
        handler.open();
    } catch (e) {
        alert('Error connecting to Plaid: ' + e.message);
        location.reload();
    }
}
</script>
{% endblock %}

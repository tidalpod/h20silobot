{% extends "base.html" %}

{% block title %}Refresh Water Bills{% endblock %}

{% block header %}
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <nav class="flex mb-2" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2">
                <li><a href="/bills" class="text-sm text-gray-500 hover:text-gray-700">Bills</a></li>
                <li><span class="text-gray-400">/</span></li>
                <li class="text-sm text-gray-900">Refresh</li>
            </ol>
        </nav>
        <h1 class="text-3xl font-bold tracking-tight text-gray-900">Refresh Water Bills</h1>
        <p class="mt-1 text-sm text-gray-500">Scrape latest water bill data from BSA Online</p>
    </div>
</header>
{% endblock %}

{% block content %}
<!-- Refresh All Bills - Main Action -->
<div class="bg-white shadow rounded-lg mb-6">
    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Refresh All Water Bills</h3>
        <p class="mt-1 text-sm text-gray-500">Fetch latest water bill amounts for all {{ properties|length }} active properties</p>
    </div>
    <div class="px-4 py-5 sm:p-6">
        <div class="flex items-center gap-3 p-4 bg-blue-50 rounded-lg mb-6">
            <span class="text-3xl">ðŸ’§</span>
            <div>
                <p class="font-medium text-gray-900">Water Bills from BSA Online</p>
                <p class="text-sm text-gray-500">Supports Warren, Roseville, and Eastpointe</p>
            </div>
        </div>

        <button id="refresh-all-btn"
                onclick="refreshAllBills()"
                class="w-full inline-flex justify-center items-center rounded-md bg-blue-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:bg-blue-500">
            <svg class="h-5 w-5 mr-2 animate-none" id="refresh-icon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
            <span id="refresh-btn-text">Refresh All Water Bills</span>
        </button>

        <div id="refresh-all-status" class="mt-4 space-y-2"></div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Refresh Single Property -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <h3 class="text-lg font-medium leading-6 text-gray-900">Refresh Single Property</h3>
            <p class="mt-1 text-sm text-gray-500">Update water bill for a specific property</p>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <div class="mb-4">
                <label for="property_select" class="block text-sm font-medium leading-6 text-gray-900">Select Property</label>
                <div class="mt-2">
                    <select id="property_select"
                            class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm px-3">
                        <option value="">Choose a property...</option>
                        {% for prop in properties %}
                        <option value="{{ prop.id }}">{{ prop.address }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button id="refresh-single-btn"
                    onclick="refreshSingleProperty()"
                    disabled
                    class="w-full inline-flex justify-center items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                Refresh Selected Property
            </button>
            <div id="refresh-single-status" class="mt-4"></div>
        </div>
    </div>

    <!-- Info Section -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <h3 class="text-lg font-medium leading-6 text-gray-900">About Water Bill Refresh</h3>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <ul class="space-y-3 text-sm text-gray-600">
                <li class="flex items-start gap-2">
                    <span class="text-blue-500">â€¢</span>
                    <span>Water bills are automatically refreshed <strong>daily at 6 AM</strong></span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-blue-500">â€¢</span>
                    <span>Connects to BSA Online and scrapes the latest data</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-blue-500">â€¢</span>
                    <span>Each property takes a few seconds to process</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-blue-500">â€¢</span>
                    <span>Bulk refresh runs in the background - check back in a few minutes</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-blue-500">â€¢</span>
                    <span>Supports <strong>Warren</strong>, <strong>Roseville</strong>, and <strong>Eastpointe</strong> properties</span>
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
    document.getElementById('property_select').addEventListener('change', function() {
        document.getElementById('refresh-single-btn').disabled = !this.value;
    });

    function setButtonLoading(isLoading) {
        const btn = document.getElementById('refresh-all-btn');
        const icon = document.getElementById('refresh-icon');
        const text = document.getElementById('refresh-btn-text');

        if (isLoading) {
            btn.disabled = true;
            icon.classList.add('animate-spin');
            text.textContent = 'Refreshing...';
        } else {
            btn.disabled = false;
            icon.classList.remove('animate-spin');
            text.textContent = 'Refresh All Water Bills';
        }
    }

    function addStatus(message, type = 'info') {
        const statusDiv = document.getElementById('refresh-all-status');
        const colors = {
            info: 'text-blue-600',
            success: 'text-green-600',
            error: 'text-red-600'
        };
        statusDiv.innerHTML += `<div class="text-sm ${colors[type]} flex items-center gap-2">
            <span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â†’'}</span>
            ${message}
        </div>`;
    }

    async function refreshAllBills() {
        const statusDiv = document.getElementById('refresh-all-status');
        statusDiv.innerHTML = '';
        setButtonLoading(true);

        try {
            addStatus('Starting water bills refresh...', 'info');
            const resp = await fetch('/api/refresh-bills', { method: 'POST' });
            const data = await resp.json();
            addStatus('Water bills refresh started in background', 'success');
            addStatus('Check back in a few minutes to see updated data', 'info');

            setTimeout(() => {
                setButtonLoading(false);
            }, 3000);

        } catch (error) {
            addStatus('Error: ' + error.message, 'error');
            setButtonLoading(false);
        }
    }

    async function refreshSingleProperty() {
        const propertyId = document.getElementById('property_select').value;
        if (!propertyId) return;

        const statusDiv = document.getElementById('refresh-single-status');
        const btn = document.getElementById('refresh-single-btn');
        const originalText = btn.innerHTML;

        btn.innerHTML = '<span class="animate-pulse">Refreshing...</span>';
        btn.disabled = true;
        statusDiv.innerHTML = '<div class="text-sm text-blue-600">Fetching water bill data...</div>';

        try {
            const resp = await fetch(`/api/properties/${propertyId}/refresh`, { method: 'POST' });
            const data = await resp.json();

            if (data.status === 'success') {
                statusDiv.innerHTML = `<div class="text-sm text-green-600">âœ“ ${data.message}</div>`;
                setTimeout(() => location.reload(), 1500);
            } else if (data.status === 'not_found') {
                statusDiv.innerHTML = `<div class="text-sm text-yellow-600">âš  ${data.message}</div>`;
                btn.innerHTML = originalText;
                btn.disabled = false;
            } else {
                statusDiv.innerHTML = `<div class="text-sm text-red-600">âœ— ${data.message || 'Error'}</div>`;
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (error) {
            statusDiv.innerHTML = `<div class="text-sm text-red-600">âœ— Error: ${error.message}</div>`;
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
</script>
{% endblock %}

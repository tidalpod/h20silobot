{% extends "base.html" %}

{% block title %}Refresh Bills{% endblock %}

{% block header %}
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <nav class="flex mb-2" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2">
                <li><a href="/bills" class="text-sm text-gray-500 hover:text-gray-700">Bills</a></li>
                <li><span class="text-gray-400">/</span></li>
                <li class="text-sm text-gray-900">Refresh</li>
            </ol>
        </nav>
        <h1 class="text-3xl font-bold tracking-tight text-gray-900">Refresh Bills</h1>
        <p class="mt-1 text-sm text-gray-500">Trigger a manual refresh of water bill data from BSA Online</p>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Refresh All -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <h3 class="text-lg font-medium leading-6 text-gray-900">Refresh All Properties</h3>
            <p class="mt-1 text-sm text-gray-500">Scrape bill data for all active properties</p>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <p class="text-sm text-gray-600 mb-4">
                This will scrape the latest bill data from BSA Online for all {{ properties|length }} active properties.
                This process runs in the background and may take several minutes.
            </p>
            <button hx-post="/api/refresh-bills"
                    hx-swap="innerHTML"
                    hx-target="#refresh-all-status"
                    class="w-full inline-flex justify-center items-center rounded-md bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500">
                <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                Refresh All Bills
            </button>
            <div id="refresh-all-status" class="mt-4"></div>
        </div>
    </div>

    <!-- Refresh Single Property -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <h3 class="text-lg font-medium leading-6 text-gray-900">Refresh Single Property</h3>
            <p class="mt-1 text-sm text-gray-500">Scrape bill data for a specific property</p>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <div class="mb-4">
                <label for="property_select" class="block text-sm font-medium leading-6 text-gray-900">Select Property</label>
                <div class="mt-2">
                    <select id="property_select"
                            class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm px-3">
                        <option value="">Choose a property...</option>
                        {% for prop in properties %}
                        <option value="{{ prop.id }}">{{ prop.address }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button id="refresh-single-btn"
                    onclick="refreshSingleProperty()"
                    disabled
                    class="w-full inline-flex justify-center items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                Refresh Selected Property
            </button>
            <div id="refresh-single-status" class="mt-4"></div>
        </div>
    </div>
</div>

<!-- Info Section -->
<div class="mt-6 bg-blue-50 rounded-lg p-4">
    <div class="flex">
        <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
            </svg>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800">About Bill Refresh</h3>
            <div class="mt-2 text-sm text-blue-700">
                <ul class="list-disc pl-5 space-y-1">
                    <li>Bills are automatically refreshed daily at 6 AM by the Telegram bot scheduler</li>
                    <li>Manual refresh connects to BSA Online and scrapes the latest bill data</li>
                    <li>Each property refresh takes a few seconds due to browser automation</li>
                    <li>Refreshing all properties runs in the background - check back in a few minutes</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('property_select').addEventListener('change', function() {
        document.getElementById('refresh-single-btn').disabled = !this.value;
    });

    function refreshSingleProperty() {
        const propertyId = document.getElementById('property_select').value;
        if (!propertyId) return;

        const statusDiv = document.getElementById('refresh-single-status');
        statusDiv.innerHTML = '<div class="text-sm text-blue-600">Starting refresh...</div>';

        fetch(`/api/properties/${propertyId}/refresh`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                statusDiv.innerHTML = `<div class="text-sm text-green-600">${data.message}</div>`;
            })
            .catch(error => {
                statusDiv.innerHTML = `<div class="text-sm text-red-600">Error: ${error.message}</div>`;
            });
    }

    // Handle HTMX response for refresh all
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'refresh-all-status') {
            const data = JSON.parse(evt.detail.xhr.responseText);
            evt.detail.target.innerHTML = `<div class="text-sm text-green-600">${data.message}</div>`;
        }
    });
</script>
{% endblock %}

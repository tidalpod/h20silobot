{% extends "base.html" %}

{% block title %}Refresh Data{% endblock %}

{% block header %}
<header class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <nav class="flex mb-2" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2">
                <li><a href="/bills" class="text-sm text-gray-500 hover:text-gray-700">Bills</a></li>
                <li><span class="text-gray-400">/</span></li>
                <li class="text-sm text-gray-900">Refresh</li>
            </ol>
        </nav>
        <h1 class="text-3xl font-bold tracking-tight text-gray-900">Refresh Property Data</h1>
        <p class="mt-1 text-sm text-gray-500">Scrape water bills, property taxes, and parcel numbers from BSA Online</p>
    </div>
</header>
{% endblock %}

{% block content %}
<!-- Refresh All Data - Main Action -->
<div class="bg-white shadow rounded-lg mb-6">
    <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
        <h3 class="text-lg font-medium leading-6 text-gray-900">Refresh All Property Data</h3>
        <p class="mt-1 text-sm text-gray-500">One-click refresh of water bills, property taxes, and parcel numbers for all {{ properties|length }} active properties</p>
    </div>
    <div class="px-4 py-5 sm:p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg">
                <span class="text-2xl">üíß</span>
                <div>
                    <p class="font-medium text-gray-900">Water Bills</p>
                    <p class="text-xs text-gray-500">Latest amounts due</p>
                </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-purple-50 rounded-lg">
                <span class="text-2xl">üèõÔ∏è</span>
                <div>
                    <p class="font-medium text-gray-900">Property Taxes</p>
                    <p class="text-xs text-gray-500">Outstanding tax balances</p>
                </div>
            </div>
            <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                <span class="text-2xl">üìç</span>
                <div>
                    <p class="font-medium text-gray-900">Parcel Numbers</p>
                    <p class="text-xs text-gray-500">Auto-discover missing parcels</p>
                </div>
            </div>
        </div>

        <button id="refresh-all-btn"
                onclick="refreshAllData()"
                class="w-full inline-flex justify-center items-center rounded-md bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-3 text-base font-semibold text-white shadow-sm hover:from-blue-500 hover:to-purple-500">
            <svg class="h-5 w-5 mr-2 animate-none" id="refresh-icon" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
            <span id="refresh-btn-text">Refresh All Data</span>
        </button>

        <div id="refresh-all-status" class="mt-4 space-y-2"></div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Refresh Single Property -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <h3 class="text-lg font-medium leading-6 text-gray-900">Refresh Single Property</h3>
            <p class="mt-1 text-sm text-gray-500">Update data for a specific property</p>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <div class="mb-4">
                <label for="property_select" class="block text-sm font-medium leading-6 text-gray-900">Select Property</label>
                <div class="mt-2">
                    <select id="property_select"
                            class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm px-3">
                        <option value="">Choose a property...</option>
                        {% for prop in properties %}
                        <option value="{{ prop.id }}">{{ prop.address }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button id="refresh-single-btn"
                    onclick="refreshSingleProperty()"
                    disabled
                    class="w-full inline-flex justify-center items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
                Refresh Selected Property
            </button>
            <div id="refresh-single-status" class="mt-4"></div>
        </div>
    </div>

    <!-- Individual Actions -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <h3 class="text-lg font-medium leading-6 text-gray-900">Individual Actions</h3>
            <p class="mt-1 text-sm text-gray-500">Run specific refresh tasks separately</p>
        </div>
        <div class="px-4 py-5 sm:p-6 space-y-3">
            <button onclick="refreshWaterOnly()" class="w-full inline-flex justify-center items-center rounded-md bg-blue-100 px-4 py-2 text-sm font-medium text-blue-700 hover:bg-blue-200">
                üíß Refresh Water Bills Only
            </button>
            <button onclick="refreshTaxesOnly()" class="w-full inline-flex justify-center items-center rounded-md bg-purple-100 px-4 py-2 text-sm font-medium text-purple-700 hover:bg-purple-200">
                üèõÔ∏è Refresh Property Taxes Only
            </button>
            <button onclick="fillParcelsOnly()" class="w-full inline-flex justify-center items-center rounded-md bg-green-100 px-4 py-2 text-sm font-medium text-green-700 hover:bg-green-200">
                üìç Find Missing Parcel Numbers Only
            </button>
            <div id="individual-status" class="mt-2"></div>
        </div>
    </div>
</div>

<!-- Info Section -->
<div class="mt-6 bg-blue-50 rounded-lg p-4">
    <div class="flex">
        <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
            </svg>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800">About Data Refresh</h3>
            <div class="mt-2 text-sm text-blue-700">
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>Water Bills</strong> are automatically refreshed daily at 6 AM</li>
                    <li><strong>Property Taxes</strong> are automatically refreshed weekly on Mondays at 7 AM</li>
                    <li><strong>Parcel Numbers</strong> are discovered automatically when refreshing taxes</li>
                    <li>Manual refresh connects to BSA Online and scrapes the latest data using browser automation</li>
                    <li>Each property takes a few seconds to process - refreshing all properties runs in the background</li>
                    <li>Check back in a few minutes after starting a full refresh</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('property_select').addEventListener('change', function() {
        document.getElementById('refresh-single-btn').disabled = !this.value;
    });

    function setButtonLoading(isLoading) {
        const btn = document.getElementById('refresh-all-btn');
        const icon = document.getElementById('refresh-icon');
        const text = document.getElementById('refresh-btn-text');

        if (isLoading) {
            btn.disabled = true;
            icon.classList.add('animate-spin');
            text.textContent = 'Refreshing...';
        } else {
            btn.disabled = false;
            icon.classList.remove('animate-spin');
            text.textContent = 'Refresh All Data';
        }
    }

    function addStatus(message, type = 'info') {
        const statusDiv = document.getElementById('refresh-all-status');
        const colors = {
            info: 'text-blue-600',
            success: 'text-green-600',
            error: 'text-red-600'
        };
        statusDiv.innerHTML += `<div class="text-sm ${colors[type]} flex items-center gap-2">
            <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Üí'}</span>
            ${message}
        </div>`;
    }

    async function refreshAllData() {
        const statusDiv = document.getElementById('refresh-all-status');
        statusDiv.innerHTML = '';
        setButtonLoading(true);

        try {
            // Start water bills refresh
            addStatus('Starting water bills refresh...', 'info');
            const billsResp = await fetch('/api/refresh-bills', { method: 'POST' });
            const billsData = await billsResp.json();
            addStatus('Water bills refresh started', 'success');

            // Start property taxes refresh
            addStatus('Starting property taxes refresh...', 'info');
            const taxesResp = await fetch('/api/refresh-taxes', { method: 'POST' });
            const taxesData = await taxesResp.json();
            addStatus('Property taxes refresh started', 'success');

            // Start parcel number discovery
            addStatus('Starting parcel number discovery...', 'info');
            const parcelsResp = await fetch('/api/fill-parcel-numbers', { method: 'POST' });
            const parcelsData = await parcelsResp.json();
            addStatus('Parcel number discovery started', 'success');

            addStatus('All refresh tasks started! Check back in a few minutes.', 'success');

            setTimeout(() => {
                setButtonLoading(false);
            }, 3000);

        } catch (error) {
            addStatus('Error: ' + error.message, 'error');
            setButtonLoading(false);
        }
    }

    async function refreshWaterOnly() {
        const statusDiv = document.getElementById('individual-status');
        statusDiv.innerHTML = '<div class="text-sm text-blue-600">Starting water bills refresh...</div>';
        try {
            const resp = await fetch('/api/refresh-bills', { method: 'POST' });
            const data = await resp.json();
            statusDiv.innerHTML = '<div class="text-sm text-green-600">‚úì ' + data.message + '</div>';
        } catch (error) {
            statusDiv.innerHTML = '<div class="text-sm text-red-600">‚úó Error: ' + error.message + '</div>';
        }
    }

    async function refreshTaxesOnly() {
        const statusDiv = document.getElementById('individual-status');
        statusDiv.innerHTML = '<div class="text-sm text-purple-600">Starting property taxes refresh...</div>';
        try {
            const resp = await fetch('/api/refresh-taxes', { method: 'POST' });
            const data = await resp.json();
            statusDiv.innerHTML = '<div class="text-sm text-green-600">‚úì ' + data.message + '</div>';
        } catch (error) {
            statusDiv.innerHTML = '<div class="text-sm text-red-600">‚úó Error: ' + error.message + '</div>';
        }
    }

    async function fillParcelsOnly() {
        const statusDiv = document.getElementById('individual-status');
        statusDiv.innerHTML = '<div class="text-sm text-green-600">Starting parcel number discovery...</div>';
        try {
            const resp = await fetch('/api/fill-parcel-numbers', { method: 'POST' });
            const data = await resp.json();
            statusDiv.innerHTML = '<div class="text-sm text-green-600">‚úì ' + data.message + '</div>';
        } catch (error) {
            statusDiv.innerHTML = '<div class="text-sm text-red-600">‚úó Error: ' + error.message + '</div>';
        }
    }

    function refreshSingleProperty() {
        const propertyId = document.getElementById('property_select').value;
        if (!propertyId) return;

        const statusDiv = document.getElementById('refresh-single-status');
        statusDiv.innerHTML = '<div class="text-sm text-blue-600">Starting refresh...</div>';

        // Refresh both water and tax for single property
        Promise.all([
            fetch(`/api/properties/${propertyId}/refresh`, { method: 'POST' }),
            fetch(`/api/properties/${propertyId}/refresh-tax`, { method: 'POST' })
        ])
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(([billData, taxData]) => {
            statusDiv.innerHTML = `
                <div class="text-sm text-green-600">‚úì Water bills: ${billData.message}</div>
                <div class="text-sm text-green-600">‚úì Property tax: ${taxData.message}</div>
            `;
        })
        .catch(error => {
            statusDiv.innerHTML = `<div class="text-sm text-red-600">‚úó Error: ${error.message}</div>`;
        });
    }
</script>
{% endblock %}

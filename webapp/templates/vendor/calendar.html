{% extends "vendor/base.html" %}

{% block title %}Calendar{% endblock %}

{% block head %}
<style>
    .cal-day { min-height: 3rem; }
    .cal-event {
        font-size: 0.65rem;
        padding: 1px 4px;
        border-radius: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
    }
    .cal-today { background-color: #f0fdf4; border: 2px solid #22c55e; }
</style>
{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
    <h1 class="text-xl font-bold text-gray-900">Calendar</h1>
</div>

<div class="portal-card p-4">
    <!-- Month Navigation -->
    <div class="flex items-center justify-between mb-4">
        <button onclick="changeMonth(-1)" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <h2 id="month-label" class="text-base font-semibold text-gray-900"></h2>
        <button onclick="changeMonth(1)" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        </button>
    </div>

    <!-- Day Headers -->
    <div class="grid grid-cols-7 mb-1">
        <div class="text-center text-xs font-medium text-gray-400 py-1">Sun</div>
        <div class="text-center text-xs font-medium text-gray-400 py-1">Mon</div>
        <div class="text-center text-xs font-medium text-gray-400 py-1">Tue</div>
        <div class="text-center text-xs font-medium text-gray-400 py-1">Wed</div>
        <div class="text-center text-xs font-medium text-gray-400 py-1">Thu</div>
        <div class="text-center text-xs font-medium text-gray-400 py-1">Fri</div>
        <div class="text-center text-xs font-medium text-gray-400 py-1">Sat</div>
    </div>

    <!-- Calendar Grid -->
    <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-gray-200 rounded-lg overflow-hidden"></div>
</div>

<!-- Selected Day Events -->
<div id="day-events" class="mt-4 hidden">
    <h3 id="day-events-title" class="text-sm font-semibold text-gray-700 mb-2"></h3>
    <div id="day-events-list" class="space-y-2"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const events = {{ events|tojson }};
    let currentDate = new Date();
    const today = new Date();

    const statusColors = {
        'assigned': 'bg-amber-100 text-amber-800',
        'in_progress': 'bg-purple-100 text-purple-800',
        'new': 'bg-blue-100 text-blue-800',
        'completed': 'bg-green-100 text-green-800',
        'closed': 'bg-gray-100 text-gray-600',
    };

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById('month-label').textContent =
            new Date(year, month, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const grid = document.getElementById('calendar-grid');

        let html = '';

        // Blank cells for days before month starts
        for (let i = 0; i < firstDay; i++) {
            html += '<div class="bg-gray-50 cal-day p-1"></div>';
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
            const dayEvents = events.filter(e => e.date === dateStr);

            html += `<div class="bg-white cal-day p-1 ${isToday ? 'cal-today' : ''} cursor-pointer hover:bg-gray-50" onclick="showDayEvents('${dateStr}', ${day})">`;
            html += `<div class="text-xs font-medium ${isToday ? 'text-green-700' : 'text-gray-700'} mb-0.5">${day}</div>`;

            dayEvents.slice(0, 2).forEach(evt => {
                const cls = statusColors[evt.status] || 'bg-gray-100 text-gray-700';
                html += `<div class="cal-event ${cls} mb-0.5" title="${evt.title}">${evt.title}</div>`;
            });
            if (dayEvents.length > 2) {
                html += `<div class="text-xs text-gray-400">+${dayEvents.length - 2} more</div>`;
            }

            html += '</div>';
        }

        // Remaining blank cells
        const totalCells = firstDay + daysInMonth;
        const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let i = 0; i < remaining; i++) {
            html += '<div class="bg-gray-50 cal-day p-1"></div>';
        }

        grid.innerHTML = html;
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
        document.getElementById('day-events').classList.add('hidden');
    }

    function showDayEvents(dateStr, day) {
        const dayEvents = events.filter(e => e.date === dateStr);
        const container = document.getElementById('day-events');
        const title = document.getElementById('day-events-title');
        const list = document.getElementById('day-events-list');

        if (dayEvents.length === 0) {
            container.classList.add('hidden');
            return;
        }

        const dateObj = new Date(dateStr + 'T12:00:00');
        title.textContent = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

        let html = '';
        dayEvents.forEach(evt => {
            const cls = statusColors[evt.status] || 'bg-gray-100 text-gray-700';
            html += `
            <a href="/vendor/work-orders/${evt.id}" class="portal-card p-3 block hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-900 truncate">${evt.title}</div>
                        <div class="text-xs text-gray-500">${evt.property}</div>
                    </div>
                    <span class="text-xs px-2 py-0.5 rounded-full ${cls} flex-shrink-0 ml-2">${evt.status.replace('_', ' ')}</span>
                </div>
            </a>`;
        });
        list.innerHTML = html;
        container.classList.remove('hidden');
    }

    renderCalendar();
</script>
{% endblock %}

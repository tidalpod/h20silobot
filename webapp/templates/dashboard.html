{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block header %}
<header class="bg-white shadow-sm">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900 flex items-center gap-3">
            <span>ğŸ“Š</span> Dashboard
        </h1>
        <p class="mt-1 text-sm text-gray-500">Your property operations at a glance.</p>
    </div>
</header>
{% endblock %}

{% block content %}
<!-- KPI Cards -->
<div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-5 mb-6">
    <!-- 1. Properties -->
    <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-100">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 bg-blue-50 rounded-xl">
                    <span class="text-2xl">ğŸ </span>
                </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-500">Properties</p>
                    <p class="text-2xl font-bold text-gray-900">{{ total_properties }}</p>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-5 py-2.5 border-t border-gray-100">
            <p class="text-xs text-gray-500">
                <span class="text-blue-600 font-medium">{{ occupied_count }} occupied</span>
                <span class="mx-1">Â·</span>
                <span class="{% if vacant_count > 0 %}text-amber-600{% else %}text-gray-400{% endif %}">{{ vacant_count }} vacant</span>
            </p>
        </div>
    </div>

    <!-- 2. Compliance -->
    <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-100">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 {% if missing_license_count > 0 %}bg-amber-50{% else %}bg-green-50{% endif %} rounded-xl">
                    <span class="text-2xl">ğŸ“œ</span>
                </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-500">Compliance</p>
                    <p class="text-2xl font-bold {% if missing_license_count > 0 %}text-amber-600{% else %}text-green-600{% endif %}">
                        {{ licensed_count }}/{{ total_properties }}
                    </p>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-5 py-2.5 border-t border-gray-100">
            <p class="text-xs {% if missing_license_count > 0 %}text-amber-600{% else %}text-gray-500{% endif %}">
                {% if missing_license_count > 0 %}
                <span class="font-medium">{{ missing_license_count }} missing license{{ 's' if missing_license_count > 1 else '' }}</span>
                {% else %}
                All licenses current
                {% endif %}
            </p>
        </div>
    </div>

    <!-- 3. Tenants -->
    <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-100">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 bg-purple-50 rounded-xl">
                    <span class="text-2xl">ğŸ‘¥</span>
                </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-500">Tenants</p>
                    <p class="text-2xl font-bold text-gray-900">{{ total_tenants }}</p>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-5 py-2.5 border-t border-gray-100">
            <p class="text-xs text-gray-500">
                <span class="text-purple-600 font-medium">{{ section8_tenants }} Section 8</span>
            </p>
        </div>
    </div>

    <!-- 4. Total Rent -->
    <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-100">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 bg-green-50 rounded-xl">
                    <span class="text-2xl">ğŸ’°</span>
                </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-500">Total Rent</p>
                    <p class="text-2xl font-bold text-green-600">${{ "{:,.0f}".format(total_rent) }}</p>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-5 py-2.5 border-t border-gray-100">
            <p class="text-xs text-gray-500">
                {% if total_section8_rent > 0 and total_regular_rent > 0 %}
                <span class="text-green-600 font-medium">${{ "{:,.0f}".format(total_section8_rent) }} Sec 8</span>
                <span class="mx-1">Â·</span>
                <span>${{ "{:,.0f}".format(total_regular_rent) }} regular</span>
                {% elif total_section8_rent > 0 %}
                <span class="text-green-600 font-medium">${{ "{:,.0f}".format(total_section8_rent) }} Section 8</span>
                {% elif total_regular_rent > 0 %}
                <span class="text-green-600 font-medium">${{ "{:,.0f}".format(total_regular_rent) }} regular</span>
                {% else %}
                <span class="text-green-600 font-medium">Monthly income</span>
                {% endif %}
            </p>
        </div>
    </div>

    <!-- 5. Maintenance -->
    <div class="bg-white overflow-hidden shadow-sm rounded-xl border border-gray-100">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0 p-3 {% if emergency_work_orders > 0 %}bg-red-50{% elif open_work_orders > 0 %}bg-orange-50{% else %}bg-green-50{% endif %} rounded-xl">
                    <span class="text-2xl">ğŸ”§</span>
                </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-500">Work Orders</p>
                    <p class="text-2xl font-bold {% if emergency_work_orders > 0 %}text-red-600{% elif open_work_orders > 0 %}text-orange-600{% else %}text-green-600{% endif %}">{{ open_work_orders }}</p>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-5 py-2.5 border-t border-gray-100">
            <p class="text-xs {% if emergency_work_orders > 0 %}text-red-600{% else %}text-gray-500{% endif %}">
                {% if emergency_work_orders > 0 %}
                <span class="font-medium">{{ emergency_work_orders }} emergency</span>
                {% elif open_work_orders > 0 %}
                <span class="font-medium">{{ open_work_orders }} open</span>
                {% else %}
                All clear
                {% endif %}
            </p>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="mb-6">
    <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold text-gray-700 flex items-center gap-2">
            <span>âš¡</span> Quick Actions
        </h2>
    </div>
    <div class="flex flex-wrap gap-3">
        <a href="/properties/new" class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-500 transition-colors">
            <span class="mr-2">â•</span> Add Property
        </a>
        <a href="/tenants/new" class="inline-flex items-center rounded-lg bg-teal-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-teal-500 transition-colors">
            <span class="mr-2">ğŸ‘¤</span> Add Tenant
        </a>
        <a href="/maintenance/new" class="inline-flex items-center rounded-lg bg-orange-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-orange-500 transition-colors">
            <span class="mr-2">ğŸ”§</span> New Work Order
        </a>
        <a href="/bills/refresh" class="inline-flex items-center rounded-lg bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 transition-colors">
            <span class="mr-2">ğŸ’§</span> Refresh All Bills
        </a>
        <a href="/listings" target="_blank" class="inline-flex items-center rounded-lg bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 transition-colors">
            <span class="mr-2">ğŸŒ</span> View Public Site
        </a>
    </div>
</div>

<!-- Four Column Layout: Inspections + Recerts + Expiring Leases + Bills -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
    <!-- Upcoming Inspections -->
    <div class="bg-white shadow-sm rounded-xl border border-gray-200">
        <div class="px-5 py-3 border-b border-gray-100 bg-orange-50 rounded-t-xl">
            <h3 class="text-sm font-semibold text-orange-800 flex items-center gap-2">
                <span>ğŸ—ï¸</span> Upcoming Inspections
            </h3>
        </div>
        {% if upcoming_inspections %}
        <ul class="divide-y divide-gray-100">
            {% for item in upcoming_inspections %}
            <li>
                <a href="/properties/{{ item.property.id }}" class="flex items-center justify-between px-5 py-3 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 text-sm flex-shrink-0">
                            {{ item.icon }}
                        </div>
                        <div class="min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">{{ item.type }}</p>
                            <p class="text-xs text-gray-500 truncate">{{ item.property.address }}</p>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-3">
                        <p class="text-sm font-medium {% if item.days_until <= 1 %}text-red-600{% elif item.days_until <= 7 %}text-amber-600{% else %}text-gray-600{% endif %}">
                            {{ item.date.strftime('%b %d') }}
                        </p>
                        <p class="text-xs {% if item.days_until <= 1 %}text-red-500{% elif item.days_until <= 7 %}text-amber-500{% else %}text-gray-400{% endif %}">
                            {% if item.days_until == 0 %}Today{% elif item.days_until == 1 %}Tomorrow{% else %}{{ item.days_until }}d{% endif %}
                        </p>
                    </div>
                </a>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="px-5 py-8 text-center">
            <span class="text-2xl text-gray-300">ğŸ—ï¸</span>
            <p class="mt-2 text-sm text-gray-400">No upcoming inspections</p>
        </div>
        {% endif %}
    </div>

    <!-- Upcoming Recertifications -->
    <div class="bg-white shadow-sm rounded-xl border border-gray-200">
        <div class="px-5 py-3 border-b border-gray-100 bg-purple-50 rounded-t-xl">
            <h3 class="text-sm font-semibold text-purple-800 flex items-center gap-2">
                <span>ğŸ“„</span> Upcoming Recertifications
            </h3>
        </div>
        {% if upcoming_recerts %}
        <ul class="divide-y divide-gray-100">
            {% for item in upcoming_recerts %}
            <li>
                <a href="/properties/{{ item.property.id }}" class="flex items-center justify-between px-5 py-3 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 text-sm font-medium flex-shrink-0">
                            {{ item.tenant.name[0]|upper }}
                        </div>
                        <div class="min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">{{ item.tenant.name }}</p>
                            <p class="text-xs text-gray-500 truncate">{{ item.property.address }}</p>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-3">
                        <p class="text-sm font-medium {% if item.days_until <= 0 %}text-green-600{% elif item.days_until <= 14 %}text-amber-600{% else %}text-gray-600{% endif %}">
                            {{ item.recert_date.strftime('%b %d') }}
                        </p>
                        <p class="text-xs {% if item.days_until <= 0 %}text-green-500{% elif item.days_until <= 14 %}text-amber-500{% else %}text-gray-400{% endif %}">
                            {% if item.days_until <= 0 %}Eligible{% else %}{{ item.days_until }}d{% endif %}
                        </p>
                    </div>
                </a>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="px-5 py-8 text-center">
            <span class="text-2xl text-gray-300">ğŸ“„</span>
            <p class="mt-2 text-sm text-gray-400">No upcoming recertifications</p>
        </div>
        {% endif %}
    </div>

    <!-- Expiring Leases -->
    <div class="bg-white shadow-sm rounded-xl border border-gray-200">
        <div class="px-5 py-3 border-b border-gray-100 bg-amber-50 rounded-t-xl">
            <h3 class="text-sm font-semibold text-amber-800 flex items-center gap-2">
                <span>ğŸ“„</span> Expiring Leases
            </h3>
        </div>
        {% if expiring_leases %}
        <ul class="divide-y divide-gray-100">
            {% for lease in expiring_leases %}
            <li>
                <a href="/leases/{{ lease.id }}" class="flex items-center justify-between px-5 py-3 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-8 h-8 rounded-full bg-amber-100 flex items-center justify-center text-amber-600 text-sm flex-shrink-0">
                            ğŸ“„
                        </div>
                        <div class="min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">{{ lease.property_ref.address if lease.property_ref else 'Unknown' }}</p>
                            <p class="text-xs text-gray-500 truncate">{{ lease.tenant_ref.name if lease.tenant_ref else 'No tenant' }}</p>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-3">
                        <p class="text-sm font-medium text-amber-600">{{ lease.lease_end.strftime('%b %d') }}</p>
                        <p class="text-xs text-amber-500">
                            {% set days_left = (lease.lease_end - today).days if lease.lease_end else 0 %}
                            {% if days_left <= 0 %}Expired{% elif days_left == 1 %}Tomorrow{% else %}{{ days_left }}d{% endif %}
                        </p>
                    </div>
                </a>
            </li>
            {% endfor %}
        </ul>
        {% if expiring_leases|length >= 5 %}
        <div class="px-5 py-2.5 bg-gray-50 text-right rounded-b-xl border-t border-gray-100">
            <a href="/leases?expiring=true" class="text-xs font-medium text-blue-600 hover:text-blue-500">View all &rarr;</a>
        </div>
        {% endif %}
        {% else %}
        <div class="px-5 py-8 text-center">
            <span class="text-2xl text-gray-300">ğŸ“„</span>
            <p class="mt-2 text-sm text-gray-400">No leases expiring soon</p>
        </div>
        {% endif %}
    </div>

    <!-- Outstanding Water Bills -->
    <div class="bg-white shadow-sm rounded-xl border border-gray-200">
        <div class="px-5 py-3 border-b border-gray-100 bg-blue-50 rounded-t-xl flex items-center justify-between">
            <h3 class="text-sm font-semibold text-blue-800 flex items-center gap-2">
                <span>ğŸ’§</span> Outstanding Water Bills
            </h3>
            {% if total_outstanding > 0 %}
            <span class="text-sm font-bold text-blue-700">${{ "{:,.0f}".format(total_outstanding) }}</span>
            {% endif %}
        </div>
        {% if outstanding_bills %}
        <ul class="divide-y divide-gray-100">
            {% for bill in outstanding_bills %}
            <li>
                <a href="/properties/{{ bill.property.id }}" class="flex items-center justify-between px-5 py-3 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-8 h-8 rounded-full {% if bill.is_overdue %}bg-red-100{% else %}bg-blue-100{% endif %} flex items-center justify-center text-sm flex-shrink-0">
                            {% if bill.is_overdue %}âš ï¸{% else %}ğŸ’§{% endif %}
                        </div>
                        <div class="min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">{{ bill.property.address }}</p>
                            <p class="text-xs text-gray-500">
                                {% if bill.due_date %}Due {{ bill.due_date.strftime('%b %d') }}{% else %}No due date{% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-3">
                        <p class="text-sm font-medium {% if bill.is_overdue %}text-red-600{% else %}text-gray-900{% endif %}">
                            ${{ "{:,.0f}".format(bill.amount) }}
                        </p>
                        {% if bill.is_overdue %}
                        <p class="text-xs text-red-500">{{ bill.days_overdue }}d overdue</p>
                        {% endif %}
                    </div>
                </a>
            </li>
            {% endfor %}
        </ul>
        {% if outstanding_bills|length >= 5 %}
        <div class="px-5 py-2.5 bg-gray-50 text-right rounded-b-xl border-t border-gray-100">
            <a href="/properties" class="text-xs font-medium text-blue-600 hover:text-blue-500">View all â†’</a>
        </div>
        {% endif %}
        {% else %}
        <div class="px-5 py-8 text-center">
            <span class="text-2xl text-gray-300">ğŸ’§</span>
            <p class="mt-2 text-sm text-gray-400">No outstanding bills</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Status Message -->
{% if all_caught_up %}
<div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200 p-6 text-center">
    <span class="text-4xl">ğŸ‰</span>
    <h3 class="mt-2 text-lg font-semibold text-green-800">All Caught Up!</h3>
    <p class="mt-1 text-sm text-green-600">No overdue bills or compliance issues.</p>
</div>
{% elif overdue_bills_count > 0 %}
<div class="bg-amber-50 rounded-xl border border-amber-200 p-4 text-center">
    <p class="text-sm text-amber-700">
        <span class="font-medium">ğŸ’§ You have {{ overdue_bills_count }} overdue water bill{{ 's' if overdue_bills_count > 1 else '' }}</span>
    </p>
</div>
{% endif %}

<!-- Portfolio Snapshot (subtle) -->
<div class="mt-6 pt-4 border-t border-gray-100">
    <p class="text-xs text-gray-400 text-center">
        <span>Vacant: {{ vacant_count }}</span>
        <span class="mx-2">Â·</span>
        <span>No License: {{ missing_license_count }}</span>
        <span class="mx-2">Â·</span>
        <span>Section 8: {{ section8_properties }}</span>
        <span class="mx-2">Â·</span>
        <span>Inspections Pending: {{ pending_inspections }}</span>
    </p>
</div>
{% endblock %}

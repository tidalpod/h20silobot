{% extends "base.html" %}

{% block title %}Lease Builder - Step 2{% endblock %}

{% block header %}
<header class="bg-white shadow-sm">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <div class="flex items-center gap-2 mb-2">
            <a href="/leases/builder" class="text-sm text-blue-600 hover:text-blue-500">&larr; All Drafts</a>
        </div>
        <h1 class="text-2xl font-bold tracking-tight text-gray-900">Rent, Deposit, & Fees</h1>
        <p class="mt-1 text-sm text-gray-500">{{ property.address if property else '' }}</p>
    </div>
</header>
{% endblock %}

{% block content %}
<!-- Step Indicator -->
<div class="mb-8 flex items-center gap-2">
    {% for i in range(1, total_steps + 1) %}
    <div class="flex items-center">
        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium {% if i == step %}bg-blue-600 text-white{% elif i < step %}bg-green-500 text-white{% else %}bg-gray-200 text-gray-500{% endif %}">
            {% if i < step %}&#10003;{% else %}{{ i }}{% endif %}
        </div>
        {% if i < total_steps %}<div class="w-8 h-0.5 {% if i < step %}bg-green-500{% else %}bg-gray-200{% endif %}"></div>{% endif %}
    </div>
    {% endfor %}
</div>

<form method="POST" action="/leases/builder/{{ builder.id }}/step/2">
    <div class="max-w-2xl space-y-6">
        <!-- Rent -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-4">
            <h2 class="text-lg font-semibold text-gray-900">Rent</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Rent *</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-500">$</span>
                        <input type="number" name="monthly_rent" value="{{ data.get('monthly_rent', '') }}" step="0.01" required class="w-full rounded-lg border border-gray-300 pl-7 pr-4 py-3 text-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rent Due Day</label>
                    <select name="rent_due_day" class="w-full rounded-lg border border-gray-300 px-4 py-3 text-sm">
                        {% for d in range(1, 29) %}
                        <option value="{{ d }}" {% if data.get('rent_due_day', 1) == d %}selected{% endif %}>{{ d }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Pet Rent (monthly)</label>
                <div class="relative">
                    <span class="absolute left-3 top-3 text-gray-500">$</span>
                    <input type="number" name="pet_rent" value="{{ data.get('pet_rent', 0) }}" step="0.01" class="w-full rounded-lg border border-gray-300 pl-7 pr-4 py-3 text-sm">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Prorated Rent (first month, if applicable)</label>
                <div class="relative">
                    <span class="absolute left-3 top-3 text-gray-500">$</span>
                    <input type="number" name="prorated_rent" value="{{ data.get('prorated_rent', '') or '' }}" step="0.01" placeholder="Leave blank if none" class="w-full rounded-lg border border-gray-300 pl-7 pr-4 py-3 text-sm">
                </div>
            </div>
        </div>

        <!-- Late Fees -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-4">
            <h2 class="text-lg font-semibold text-gray-900">Late Fee Policy</h2>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Grace Days</label>
                    <input type="number" name="late_fee_grace_days" value="{{ data.get('late_fee_grace_days', 5) }}" class="w-full rounded-lg border border-gray-300 px-4 py-3 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">$/Day Late Fee</label>
                    <input type="number" name="late_fee_daily" value="{{ data.get('late_fee_daily', 15) }}" step="0.01" class="w-full rounded-lg border border-gray-300 px-4 py-3 text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Max Penalty Days</label>
                    <input type="number" name="late_fee_max_days" value="{{ data.get('late_fee_max_days', 5) }}" class="w-full rounded-lg border border-gray-300 px-4 py-3 text-sm">
                </div>
            </div>
            <p class="text-xs text-gray-400">Max late fee: ${{ data.get('late_fee_daily', 15) * data.get('late_fee_max_days', 5) }}/month</p>
        </div>

        <!-- Security Deposit -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-4">
            <h2 class="text-lg font-semibold text-gray-900">Deposits</h2>
            <p class="text-xs text-amber-600 bg-amber-50 rounded-lg p-2">Michigan law: Security deposit cannot exceed 1.5x monthly rent</p>
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Security Deposit</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-500">$</span>
                        <input type="number" name="security_deposit" value="{{ data.get('security_deposit', '') }}" step="0.01" class="w-full rounded-lg border border-gray-300 pl-7 pr-4 py-3 text-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pet Deposit</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-500">$</span>
                        <input type="number" name="pet_deposit" value="{{ data.get('pet_deposit', 0) }}" step="0.01" class="w-full rounded-lg border border-gray-300 pl-7 pr-4 py-3 text-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Other Deposit</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-500">$</span>
                        <input type="number" name="other_deposit" value="{{ data.get('other_deposit', 0) }}" step="0.01" class="w-full rounded-lg border border-gray-300 pl-7 pr-4 py-3 text-sm">
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Deposit Bank Name</label>
                <input type="text" name="deposit_bank_name" value="{{ data.get('deposit_bank_name', '') }}" class="w-full rounded-lg border border-gray-300 px-4 py-3 text-sm" placeholder="Financial institution holding the deposit">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Deposit Bank Address</label>
                <input type="text" name="deposit_bank_address" value="{{ data.get('deposit_bank_address', '') }}" class="w-full rounded-lg border border-gray-300 px-4 py-3 text-sm">
            </div>
        </div>

        <!-- Move-in Fees -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-4">
            <h2 class="text-lg font-semibold text-gray-900">One-Time Move-In Fees</h2>
            <div id="fees-container">
                {% for fee in data.get('move_in_fees', []) %}
                <div class="flex gap-3 mb-2 fee-row">
                    <input type="text" name="fee_description" value="{{ fee.description }}" placeholder="Description" class="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm">
                    <div class="relative w-32">
                        <span class="absolute left-3 top-2 text-gray-500">$</span>
                        <input type="number" name="fee_amount" value="{{ fee.amount }}" step="0.01" class="w-full rounded-lg border border-gray-300 pl-7 pr-3 py-2 text-sm">
                    </div>
                    <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 text-sm px-2">&times;</button>
                </div>
                {% endfor %}
            </div>
            <button type="button" onclick="addFeeRow()" class="text-sm text-blue-600 hover:text-blue-500 font-medium">+ Add Fee</button>
        </div>

        <!-- Payment Methods -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 space-y-3">
            <h2 class="text-lg font-semibold text-gray-900">Accepted Payment Methods</h2>
            {% set methods = data.get('payment_methods', ['ach', 'bluedeer']) %}
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" name="payment_methods" value="ach" {% if 'ach' in methods %}checked{% endif %} class="text-blue-600 rounded">
                <span class="text-sm">ACH Bank Transfer</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" name="payment_methods" value="bluedeer" {% if 'bluedeer' in methods %}checked{% endif %} class="text-blue-600 rounded">
                <span class="text-sm">Blue Deer Tenant Portal</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" name="payment_methods" value="check" {% if 'check' in methods %}checked{% endif %} class="text-blue-600 rounded">
                <span class="text-sm">Personal Check</span>
            </label>
            <label class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" name="payment_methods" value="money_order" {% if 'money_order' in methods %}checked{% endif %} class="text-blue-600 rounded">
                <span class="text-sm">Money Order</span>
            </label>
        </div>
    </div>

    <!-- Navigation -->
    <div class="mt-6 flex justify-between max-w-2xl">
        <a href="/leases/builder/{{ builder.id }}/step/1" class="px-6 py-3 rounded-lg text-sm font-medium text-gray-700 bg-white ring-1 ring-gray-300 hover:bg-gray-50">&larr; Back</a>
        <div class="flex gap-3">
            <button type="submit" name="action" value="save" class="px-6 py-3 rounded-lg text-sm font-medium text-gray-700 bg-white ring-1 ring-gray-300 hover:bg-gray-50">Save</button>
            <button type="submit" name="action" value="continue" class="px-6 py-3 rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-500 shadow-sm">Save & Continue &rarr;</button>
        </div>
    </div>
</form>

<script>
function addFeeRow() {
    const container = document.getElementById('fees-container');
    const row = document.createElement('div');
    row.className = 'flex gap-3 mb-2 fee-row';
    row.innerHTML = `
        <input type="text" name="fee_description" placeholder="Description" class="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm">
        <div class="relative w-32">
            <span class="absolute left-3 top-2 text-gray-500">$</span>
            <input type="number" name="fee_amount" step="0.01" class="w-full rounded-lg border border-gray-300 pl-7 pr-3 py-2 text-sm">
        </div>
        <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 text-sm px-2">&times;</button>
    `;
    container.appendChild(row);
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Lease Builder - Review{% endblock %}

{% block header %}
<header class="bg-white shadow-sm">
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <div class="flex items-center gap-2 mb-2">
            <a href="/leases/builder" class="text-sm text-blue-600 hover:text-blue-500">&larr; All Drafts</a>
        </div>
        <h1 class="text-2xl font-bold tracking-tight text-gray-900">Review Lease</h1>
        <p class="mt-1 text-sm text-gray-500">{{ property.address if property else '' }}</p>
    </div>
</header>
{% endblock %}

{% block content %}
{% if request.query_params.get('error') %}
<div class="mb-6 p-4 rounded-xl bg-red-50 border border-red-200">
    <p class="text-sm font-medium text-red-800">{{ request.query_params.get('error') }}</p>
</div>
{% endif %}

<div class="max-w-3xl space-y-6">
    <!-- Step 1: Lease Specifics -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">1. Lease Specifics</h2>
            <a href="/leases/builder/{{ builder.id }}/step/1" class="text-sm text-blue-600 hover:text-blue-500">Edit</a>
        </div>
        <dl class="grid grid-cols-2 gap-4 text-sm">
            <div>
                <dt class="text-gray-500">Property</dt>
                <dd class="font-medium text-gray-900">{{ property.address if property else '—' }}{% if property and property.city %}, {{ property.city }}, {{ property.state }} {{ property.zip_code }}{% endif %}</dd>
            </div>
            <div>
                <dt class="text-gray-500">Lease Type</dt>
                <dd class="font-medium text-gray-900">{{ 'Fixed Term' if data.get('lease_type', 'fixed') == 'fixed' else 'Month-to-Month' }}</dd>
            </div>
            <div>
                <dt class="text-gray-500">Start Date</dt>
                <dd class="font-medium text-gray-900">{{ data.get('start_date', '—') }}</dd>
            </div>
            {% if data.get('lease_type', 'fixed') == 'fixed' %}
            <div>
                <dt class="text-gray-500">End Date</dt>
                <dd class="font-medium text-gray-900">{{ data.get('end_date', '—') }}</dd>
            </div>
            {% endif %}
        </dl>
    </div>

    <!-- Step 2: Rent & Deposits -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">2. Rent, Deposit, & Fees</h2>
            <a href="/leases/builder/{{ builder.id }}/step/2" class="text-sm text-blue-600 hover:text-blue-500">Edit</a>
        </div>
        <dl class="grid grid-cols-3 gap-4 text-sm">
            <div>
                <dt class="text-gray-500">Monthly Rent</dt>
                <dd class="font-medium text-gray-900">${{ "{:,.2f}".format(data.get('monthly_rent', 0)) }}</dd>
            </div>
            <div>
                <dt class="text-gray-500">Security Deposit</dt>
                <dd class="font-medium text-gray-900">${{ "{:,.2f}".format(data.get('security_deposit', 0)) }}</dd>
            </div>
            <div>
                <dt class="text-gray-500">Late Fee</dt>
                <dd class="font-medium text-gray-900">${{ data.get('late_fee_daily', 15) }}/day after {{ data.get('late_fee_grace_days', 5) }} days</dd>
            </div>
        </dl>
        {% if data.get('move_in_fees') %}
        <div class="mt-3 pt-3 border-t border-gray-100">
            <p class="text-xs text-gray-500 mb-1">Move-in Fees:</p>
            {% for fee in data.get('move_in_fees', []) %}
            <span class="text-sm text-gray-700">{{ fee.description }}: ${{ "{:,.2f}".format(fee.amount) }}{% if not loop.last %}, {% endif %}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Step 3: People -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">3. People on the Lease</h2>
            <a href="/leases/builder/{{ builder.id }}/step/3" class="text-sm text-blue-600 hover:text-blue-500">Edit</a>
        </div>
        <div class="space-y-3 text-sm">
            <div>
                <p class="text-gray-500 mb-1">Tenants:</p>
                {% for t in data.get('tenants', []) %}
                <p class="font-medium text-gray-900">{{ t.name }}{% if t.email %} ({{ t.email }}){% endif %}</p>
                {% endfor %}
            </div>
            {% if data.get('additional_occupants') %}
            <div>
                <p class="text-gray-500 mb-1">Additional Occupants:</p>
                {% for o in data.get('additional_occupants', []) %}
                <p class="text-gray-700">{{ o.name }} ({{ o.relationship }}, age {{ o.age }})</p>
                {% endfor %}
            </div>
            {% endif %}
            {% set ll = data.get('landlord', {}) %}
            {% if ll %}
            <div>
                <p class="text-gray-500 mb-1">Landlord:</p>
                <p class="font-medium text-gray-900">{{ ll.get('entity_name', '') }}{% if ll.get('owner_name') %} — {{ ll.get('owner_name') }}{% endif %}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Step 4: Pets & Other -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">4. Pets, Smoking, & Other</h2>
            <a href="/leases/builder/{{ builder.id }}/step/4" class="text-sm text-blue-600 hover:text-blue-500">Edit</a>
        </div>
        <dl class="grid grid-cols-3 gap-4 text-sm">
            <div>
                <dt class="text-gray-500">Pets</dt>
                <dd class="font-medium text-gray-900">{{ 'Allowed' if data.get('pets_allowed') else 'Not Allowed' }}</dd>
            </div>
            <div>
                <dt class="text-gray-500">Smoking</dt>
                <dd class="font-medium text-gray-900">{{ 'Not Permitted' if data.get('smoking_policy', 'not_permitted') == 'not_permitted' else 'Designated Areas' }}</dd>
            </div>
            <div>
                <dt class="text-gray-500">Renters Insurance</dt>
                <dd class="font-medium text-gray-900">{{ 'Required' if data.get('renters_insurance_required') else 'Not Required' }}</dd>
            </div>
        </dl>
    </div>

    <!-- Step 5: Utilities -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">5. Utilities & Keys</h2>
            <a href="/leases/builder/{{ builder.id }}/step/5" class="text-sm text-blue-600 hover:text-blue-500">Edit</a>
        </div>
        {% if data.get('utilities') %}
        <div class="grid grid-cols-4 gap-2 text-sm">
            {% for name, resp in data.get('utilities', {}).items() %}
            <div class="p-2 rounded bg-gray-50">
                <span class="text-gray-500">{{ name.replace('_', ' ').title() }}</span>
                <span class="block font-medium text-gray-900">{{ resp.title() }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Step 6: Provisions -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">6. Provisions</h2>
            <a href="/leases/builder/{{ builder.id }}/step/6" class="text-sm text-blue-600 hover:text-blue-500">Edit</a>
        </div>
        <dl class="grid grid-cols-2 gap-4 text-sm">
            <div>
                <dt class="text-gray-500">Early Termination</dt>
                <dd class="font-medium text-gray-900">{{ 'Included' if data.get('early_termination') else 'Not Included' }}</dd>
            </div>
            <div>
                <dt class="text-gray-500">Lead Paint Disclosure</dt>
                <dd class="font-medium text-gray-900">{{ 'Included' if data.get('lead_paint_disclosure') else 'Not Included' }}</dd>
            </div>
        </dl>
        {% if data.get('additional_terms') %}
        <div class="mt-3 pt-3 border-t border-gray-100">
            <p class="text-xs text-gray-500 mb-1">Additional Terms:</p>
            <p class="text-sm text-gray-700">{{ data.get('additional_terms')[:200] }}{% if data.get('additional_terms', '')|length > 200 %}...{% endif %}</p>
        </div>
        {% endif %}
    </div>

    <!-- Generate Button -->
    <div class="flex justify-between items-center bg-white rounded-xl shadow-sm border border-gray-100 p-6">
        <div>
            <h3 class="font-semibold text-gray-900">Ready to generate?</h3>
            <p class="text-sm text-gray-500">This will create a Michigan Residential Rental Agreement PDF</p>
        </div>
        <form method="POST" action="/leases/builder/{{ builder.id }}/generate">
            <button type="submit" class="px-8 py-3 rounded-lg text-sm font-medium text-white bg-green-600 hover:bg-green-500 shadow-sm transition-colors">
                Generate Lease PDF
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% extends "base.html" %}

{% block title %}SMS Conversations{% endblock %}

{% block header %}
<header class="bg-white shadow-sm">
    <div class="mx-auto max-w-7xl px-4 py-4 sm:py-6 sm:px-6 lg:px-8 flex justify-between items-center">
        <div>
            <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-gray-900 flex items-center gap-2 sm:gap-3">
                <span>üí¨</span> SMS Conversations
            </h1>
            <p class="mt-1 text-sm text-gray-500 hidden sm:block">Chat with tenants via SMS</p>
        </div>
        <button onclick="openNewConversationModal()" class="inline-flex items-center rounded-lg bg-blue-600 px-3 py-2 sm:px-4 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 transition-colors">
            <span class="mr-1 sm:mr-2">+</span><span class="hidden sm:inline">New </span>Chat
        </button>
    </div>
</header>
{% endblock %}

{% block content %}
<style>
    /* Mobile: full-screen panels that slide */
    @media (max-width: 767px) {
        .chat-wrapper { height: calc(100dvh - 160px); height: calc(100vh - 160px); }
        .panel-list { display: flex; flex-direction: column; width: 100%; }
        .panel-chat { display: none; flex-direction: column; width: 100%; position: absolute; inset: 0; background: white; z-index: 10; }
        .panel-chat.active { display: flex; }
        .chat-wrapper { position: relative; }
        .back-btn { display: flex; }
    }
    /* Desktop: side by side */
    @media (min-width: 768px) {
        .chat-wrapper { height: calc(100vh - 220px); min-height: 500px; }
        .panel-list { width: 320px; border-right: 1px solid #e5e7eb; }
        .panel-chat { flex: 1; }
        .panel-chat, .panel-list { display: flex; flex-direction: column; }
        .back-btn { display: none; }
    }
</style>

<div class="chat-wrapper flex bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <!-- Conversations List -->
    <div class="panel-list" id="panel-list">
        <div class="p-3 sm:p-4 border-b border-gray-100 bg-gray-50">
            <h2 class="text-sm font-semibold text-gray-700">Conversations</h2>
        </div>
        <div id="conversations-list" class="flex-1 overflow-y-auto">
            <div id="conversations-loading" class="p-4 text-center text-gray-500">
                <div class="animate-pulse">Loading conversations...</div>
            </div>
        </div>
    </div>

    <!-- Chat Panel -->
    <div class="panel-chat" id="panel-chat">
        <!-- Chat Header -->
        <div id="chat-header" class="p-3 sm:p-4 border-b border-gray-100 bg-gray-50">
            <div id="chat-header-content" class="hidden flex items-center gap-3">
                <button class="back-btn items-center justify-center w-8 h-8 -ml-1 rounded-full hover:bg-gray-200 transition-colors" onclick="showListPanel()">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/>
                    </svg>
                </button>
                <div class="min-w-0 flex-1">
                    <h3 id="chat-tenant-name" class="text-base sm:text-lg font-semibold text-gray-900 truncate"></h3>
                    <p id="chat-tenant-info" class="text-xs sm:text-sm text-gray-500 truncate"></p>
                </div>
            </div>
            <div id="chat-header-empty" class="text-gray-400 text-sm">
                Select a conversation to start chatting
            </div>
        </div>

        <!-- Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-3 sm:p-4 space-y-3 sm:space-y-4 bg-gray-50">
            <div id="messages-empty" class="h-full flex items-center justify-center">
                <div class="text-center text-gray-400">
                    <span class="text-4xl">üí¨</span>
                    <p class="mt-2">Select a tenant to view messages</p>
                </div>
            </div>
        </div>

        <!-- Message Input -->
        <div id="chat-input-area" class="p-2 sm:p-4 border-t border-gray-200 bg-white hidden">
            <form id="send-message-form" class="flex gap-2 sm:gap-3">
                <input type="hidden" id="current-tenant-id" value="">
                <input
                    type="text"
                    id="message-input"
                    name="message"
                    placeholder="Type your message..."
                    class="flex-1 rounded-full sm:rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm px-4 py-2"
                    autocomplete="off"
                >
                <button
                    type="submit"
                    class="inline-flex items-center justify-center rounded-full sm:rounded-lg bg-blue-600 w-10 h-10 sm:w-auto sm:h-auto sm:px-4 sm:py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 flex-shrink-0"
                >
                    <svg class="w-5 h-5 sm:w-4 sm:h-4 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                    <span class="hidden sm:inline">Send</span>
                </button>
            </form>
            <p id="send-error" class="mt-2 text-sm text-red-600 hidden"></p>
        </div>
    </div>
</div>

<!-- Unmatched Messages Section -->
<div class="mt-6 bg-white rounded-xl shadow-sm border border-gray-200 p-4 sm:p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
        <span>‚ùì</span> Unmatched Messages
        <span id="unmatched-count" class="text-sm font-normal text-gray-500"></span>
    </h3>
    <div id="unmatched-list" class="space-y-3">
        <p class="text-sm text-gray-500">Messages from unknown numbers will appear here.</p>
    </div>
</div>

<!-- New Conversation Modal -->
<div id="new-conversation-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50 transition-opacity" onclick="closeNewConversationModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[80vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">Start New Conversation</h3>
                <button onclick="closeNewConversationModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-4 border-b border-gray-100">
                <input
                    type="text"
                    id="tenant-search"
                    placeholder="Search tenants by name, address, or phone..."
                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    oninput="searchTenants(this.value)"
                >
            </div>
            <div id="tenant-list" class="flex-1 overflow-y-auto p-2 min-h-[200px] max-h-[400px]">
                <div class="text-center text-gray-400 py-8">
                    <div class="animate-pulse">Loading tenants...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentTenantId = null;
let refreshInterval = null;

// Mobile panel switching
function showChatPanel() {
    document.getElementById('panel-chat').classList.add('active');
}
function showListPanel() {
    document.getElementById('panel-chat').classList.remove('active');
}

// Load conversations list
async function loadConversations() {
    try {
        const response = await fetch('/sms/recent');
        const data = await response.json();

        const container = document.getElementById('conversations-list');

        if (data.conversations.length === 0) {
            container.innerHTML = `
                <div class="p-4 text-center text-gray-500 text-sm">
                    <p>No conversations yet.</p>
                    <p class="mt-1">Send an SMS to a tenant to start.</p>
                </div>
            `;
            return;
        }

        let html = '';
        for (const conv of data.conversations) {
            const isActive = conv.tenant_id === currentTenantId ? 'bg-blue-50 border-l-4 border-blue-500' : 'hover:bg-gray-50';
            const lastTime = conv.last_message_time ? new Date(conv.last_message_time).toLocaleString('en-US', {
                month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
            }) : '';
            const directionIcon = conv.last_direction === 'inbound' ? '‚Üê' : '‚Üí';

            html += `
                <div class="p-3 sm:p-4 border-b border-gray-100 cursor-pointer ${isActive}"
                     onclick="selectConversation(${conv.tenant_id})">
                    <div class="flex justify-between items-start mb-1">
                        <h4 class="font-medium text-gray-900 text-sm">${conv.tenant_name}</h4>
                        <span class="text-xs text-gray-400 flex-shrink-0 ml-2">${lastTime}</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate">${conv.property_address}</p>
                    <p class="text-sm text-gray-600 truncate mt-1">
                        <span class="text-gray-400">${directionIcon}</span>
                        ${conv.last_message}
                    </p>
                    ${conv.unread_count > 0 ? `
                        <span class="inline-flex items-center rounded-full bg-blue-100 px-2 py-0.5 text-xs font-medium text-blue-700 mt-1">
                            ${conv.unread_count} new
                        </span>
                    ` : ''}
                </div>
            `;
        }
        container.innerHTML = html;

    } catch (error) {
        console.error('Error loading conversations:', error);
        document.getElementById('conversations-list').innerHTML = `
            <div class="p-4 text-center text-red-500 text-sm">Failed to load conversations</div>
        `;
    }
}

// Select a conversation
async function selectConversation(tenantId) {
    currentTenantId = tenantId;
    document.getElementById('current-tenant-id').value = tenantId;

    // Update UI states
    document.getElementById('chat-header-content').classList.remove('hidden');
    document.getElementById('chat-header-empty').classList.add('hidden');
    document.getElementById('chat-input-area').classList.remove('hidden');
    const emptyEl = document.getElementById('messages-empty');
    if (emptyEl) emptyEl.classList.add('hidden');

    // On mobile, slide to chat panel
    showChatPanel();

    // Reload conversations list to update active state
    loadConversations();

    // Load messages
    await loadMessages(tenantId);

    // Start auto-refresh
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(() => loadMessages(tenantId), 5000);
}

// Load messages for a tenant
async function loadMessages(tenantId) {
    try {
        const response = await fetch(`/sms/conversation/${tenantId}`);
        const data = await response.json();

        // Update header
        document.getElementById('chat-tenant-name').textContent = data.tenant.name;
        document.getElementById('chat-tenant-info').textContent =
            `${data.tenant.phone} ‚Ä¢ ${data.tenant.property || 'No property'}`;

        // Render messages
        const container = document.getElementById('chat-messages');

        if (data.error) {
            container.innerHTML = `
                <div class="text-center text-amber-600 py-8">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <p class="mt-2">${data.error}</p>
                </div>
            `;
            document.getElementById('chat-input-area').classList.add('hidden');
            return;
        }

        if (data.messages.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <span class="text-2xl">üí¨</span>
                    <p class="mt-2">No messages yet. Send the first message!</p>
                </div>
            `;
            return;
        }

        let html = '';
        for (const msg of data.messages) {
            const isOutbound = msg.direction === 'outbound';
            const time = msg.created_at ? new Date(msg.created_at).toLocaleString('en-US', {
                month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
            }) : '';

            if (isOutbound) {
                html += `
                    <div class="flex justify-end">
                        <div class="max-w-[80%] sm:max-w-[70%]">
                            <div class="bg-blue-600 text-white rounded-2xl rounded-br-sm px-4 py-2">
                                <p class="text-sm">${escapeHtml(msg.body)}</p>
                            </div>
                            <p class="text-xs text-gray-400 text-right mt-1">${time}</p>
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="flex justify-start">
                        <div class="max-w-[80%] sm:max-w-[70%]">
                            <div class="bg-white border border-gray-200 rounded-2xl rounded-bl-sm px-4 py-2 shadow-sm">
                                <p class="text-sm text-gray-900">${escapeHtml(msg.body)}</p>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">${time}</p>
                        </div>
                    </div>
                `;
            }
        }

        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;

    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

// Send message
document.getElementById('send-message-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const tenantId = document.getElementById('current-tenant-id').value;
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    const errorEl = document.getElementById('send-error');

    if (!message) return;

    errorEl.classList.add('hidden');

    try {
        const formData = new FormData();
        formData.append('message', message);

        const response = await fetch(`/sms/send/${tenantId}`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            messageInput.value = '';
            await loadMessages(tenantId);
            loadConversations();
        } else {
            errorEl.textContent = data.error || 'Failed to send message';
            errorEl.classList.remove('hidden');
        }

    } catch (error) {
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.classList.remove('hidden');
    }
});

// Load unmatched messages
async function loadUnmatched() {
    try {
        const response = await fetch('/sms/unmatched');
        const data = await response.json();

        const container = document.getElementById('unmatched-list');
        const countEl = document.getElementById('unmatched-count');

        if (data.messages.length === 0) {
            countEl.textContent = '';
            container.innerHTML = `<p class="text-sm text-gray-400">No unmatched messages</p>`;
            return;
        }

        countEl.textContent = `(${data.messages.length})`;

        let html = '';
        for (const msg of data.messages) {
            const time = msg.created_at ? new Date(msg.created_at).toLocaleString('en-US', {
                month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
            }) : '';

            html += `
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-sm font-medium text-amber-800">${msg.from_number}</span>
                        <span class="text-xs text-amber-600">${time}</span>
                    </div>
                    <p class="text-sm text-amber-900">${escapeHtml(msg.body)}</p>
                </div>
            `;
        }
        container.innerHTML = html;

    } catch (error) {
        console.error('Error loading unmatched messages:', error);
    }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadConversations();
    loadUnmatched();
    setInterval(loadUnmatched, 30000);
});

// =============================================================================
// New Conversation Modal
// =============================================================================

let allTenants = [];

function openNewConversationModal() {
    document.getElementById('new-conversation-modal').classList.remove('hidden');
    document.getElementById('tenant-search').value = '';
    loadTenantsForModal();
}

function closeNewConversationModal() {
    document.getElementById('new-conversation-modal').classList.add('hidden');
}

async function loadTenantsForModal() {
    try {
        const response = await fetch('/sms/tenants-with-phone');
        const data = await response.json();
        allTenants = data.tenants;
        renderTenantList(allTenants);
    } catch (error) {
        console.error('Error loading tenants:', error);
        document.getElementById('tenant-list').innerHTML = `
            <div class="text-center text-red-500 py-8">Failed to load tenants</div>
        `;
    }
}

function searchTenants(query) {
    const search = query.toLowerCase().trim();
    if (!search) {
        renderTenantList(allTenants);
        return;
    }
    const filtered = allTenants.filter(t =>
        t.name.toLowerCase().includes(search) ||
        t.property_address.toLowerCase().includes(search) ||
        t.phone.includes(search)
    );
    renderTenantList(filtered);
}

function renderTenantList(tenants) {
    const container = document.getElementById('tenant-list');

    if (tenants.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-400 py-8">
                <span class="text-3xl">üì±</span>
                <p class="mt-2">No tenants with phone numbers found</p>
            </div>
        `;
        return;
    }

    let html = '';
    for (const tenant of tenants) {
        html += `
            <div class="p-3 rounded-lg hover:bg-blue-50 cursor-pointer transition-colors border border-transparent hover:border-blue-200"
                 onclick="startConversationWith(${tenant.id})">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-semibold">
                        ${tenant.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-medium text-gray-900 text-sm">${escapeHtml(tenant.name)}</h4>
                        <p class="text-xs text-gray-500 truncate">${escapeHtml(tenant.property_address)}</p>
                        <p class="text-xs text-gray-400">${escapeHtml(tenant.phone)}</p>
                    </div>
                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                </div>
            </div>
        `;
    }
    container.innerHTML = html;
}

function startConversationWith(tenantId) {
    closeNewConversationModal();
    selectConversation(tenantId);
}

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeNewConversationModal();
    }
});
</script>
{% endblock %}
